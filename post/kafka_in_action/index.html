<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>[笔记]Kafka 核心技术与实战 （更新中） - PPD&#39;s blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="PPD" />
  <meta name="description" content="第一讲 消息系统 ABC 定义 维基百科版: 消息系统是一组规范，利用这组规范在不同系统之间传递语义准确的消息，实现松耦合的异步数据传递。 传输模型 点对点 发" />

  <meta name="keywords" content="PPD, blog" />






<meta name="generator" content="Hugo 0.86.0-DEV" />


<link rel="canonical" href="https://ppd0705.github.io/post/kafka_in_action/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="[笔记]Kafka 核心技术与实战 （更新中）" />
<meta property="og:description" content="第一讲 消息系统 ABC 定义 维基百科版: 消息系统是一组规范，利用这组规范在不同系统之间传递语义准确的消息，实现松耦合的异步数据传递。 传输模型 点对点 发" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ppd0705.github.io/post/kafka_in_action/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-29T08:20:51+08:00" />
<meta property="article:modified_time" content="2022-07-01T11:20:51+08:00" />

<meta itemprop="name" content="[笔记]Kafka 核心技术与实战 （更新中）">
<meta itemprop="description" content="第一讲 消息系统 ABC 定义 维基百科版: 消息系统是一组规范，利用这组规范在不同系统之间传递语义准确的消息，实现松耦合的异步数据传递。 传输模型 点对点 发"><meta itemprop="datePublished" content="2022-06-29T08:20:51+08:00" />
<meta itemprop="dateModified" content="2022-07-01T11:20:51+08:00" />
<meta itemprop="wordCount" content="4502">
<meta itemprop="keywords" content="消息队列," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[笔记]Kafka 核心技术与实战 （更新中）"/>
<meta name="twitter:description" content="第一讲 消息系统 ABC 定义 维基百科版: 消息系统是一组规范，利用这组规范在不同系统之间传递语义准确的消息，实现松耦合的异步数据传递。 传输模型 点对点 发"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">PPD's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/about">About</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      PPD's blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/about">About</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">[笔记]Kafka 核心技术与实战 （更新中）</h1>
      
      <div class="post-meta">
        <time datetime="2022-06-29" class="post-time">
          2022-06-29
        </time>
        <div class="post-category">
            <a href="https://ppd0705.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/"> 计算机 </a>
            
          </div>
        <span class="more-meta"> 4502 words </span>
          <span class="more-meta"> 9 min read </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#第一讲-消息系统-abc">第一讲 消息系统 ABC</a>
      <ul>
        <li><a href="#定义">定义</a></li>
        <li><a href="#传输模型">传输模型</a></li>
        <li><a href="#核心作用">核心作用</a></li>
      </ul>
    </li>
    <li><a href="#第二讲-kafka-术语">第二讲 kafka 术语</a></li>
    <li><a href="#第四讲-kafka-发现版本">第四讲 kafka 发现版本</a>
      <ul>
        <li><a href="#apache-kafka">Apache Kafka</a></li>
        <li><a href="#confluent-kafka">Confluent Kafka</a></li>
        <li><a href="#cdhhdp-kafka">CDH/HDP Kafka</a></li>
      </ul>
    </li>
    <li><a href="#第六讲-线上集群部署">第六讲 线上集群部署</a>
      <ul>
        <li><a href="#操作系统">操作系统</a></li>
        <li><a href="#磁盘">磁盘</a></li>
        <li><a href="#磁盘容量">磁盘容量</a></li>
        <li><a href="#带宽">带宽</a></li>
      </ul>
    </li>
    <li><a href="#第七讲-最最最重要集群参数上">第七讲 最最最重要集群参数（上）</a>
      <ul>
        <li><a href="#broker-参数">Broker 参数</a>
          <ul>
            <li><a href="#存储相关">存储相关</a></li>
            <li><a href="#zookeeper-相关">zookeeper 相关</a></li>
            <li><a href="#topic-管理相关">topic 管理相关</a></li>
            <li><a href="#数据留存相关">数据留存相关</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第八讲-最最最重要集群参数下">第八讲 最最最重要集群参数（下）</a>
      <ul>
        <li><a href="#topic-级别参数">Topic 级别参数</a></li>
        <li><a href="#jvm-参数">JVM 参数</a></li>
        <li><a href="#操作系统参数">操作系统参数</a></li>
      </ul>
    </li>
    <li><a href="#第九讲--消息分区机制原理">第九讲  消息分区机制原理</a>
      <ul>
        <li><a href="#分区作用">分区作用</a></li>
        <li><a href="#分区写入策略">分区写入策略</a>
          <ul>
            <li><a href="#轮询策略">轮询策略</a></li>
            <li><a href="#随机策略">随机策略</a></li>
            <li><a href="#按消息键分配策略">按消息键分配策略</a></li>
            <li><a href="#显式指定分区">显式指定分区</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第十讲-压缩算法">第十讲 压缩算法</a>
      <ul>
        <li><a href="#流程">流程</a></li>
        <li><a href="#压缩算法对比">压缩算法对比</a></li>
      </ul>
    </li>
    <li><a href="#第十一讲-无消息丢失配置">第十一讲 无消息丢失配置</a>
      <ul>
        <li><a href="#producer端">producer端</a></li>
        <li><a href="#broker-端">broker 端</a></li>
        <li><a href="#consumer-端">consumer 端</a></li>
      </ul>
    </li>
    <li><a href="#第十二讲-拦截器">第十二讲 拦截器</a></li>
    <li><a href="#第十四讲-幂等和事务">第十四讲 幂等和事务</a>
      <ul>
        <li><a href="#幂等性-producer">幂等性 Producer</a></li>
        <li><a href="#事务型-producer">事务型 Producer</a></li>
      </ul>
    </li>
    <li><a href="#第十五讲-消费者组">第十五讲 消费者组</a>
      <ul>
        <li><a href="#特性">特性</a></li>
        <li><a href="#实例数量设置">实例数量设置</a></li>
        <li><a href="#rebalance-触发条件">rebalance 触发条件</a></li>
      </ul>
    </li>
    <li><a href="#第十六讲-位移主题">第十六讲 位移主题</a></li>
    <li><a href="#第十七讲-消费者组重平衡">第十七讲 消费者组重平衡</a></li>
    <li><a href="#第-18-讲-位移提交">第 18 讲 位移提交</a>
      <ul>
        <li><a href="#自动提交">自动提交</a></li>
      </ul>
    </li>
    <li><a href="#手动提交">手动提交</a></li>
    <li><a href="#第二十一讲-java-版消费者-tcp-连接管理">第二十一讲 Java 版消费者 TCP 连接管理</a>
      <ul>
        <li><a href="#创建连接时机">创建连接时机</a></li>
        <li><a href="#案例分析">案例分析</a></li>
      </ul>
    </li>
    <li><a href="#第二十二讲-消费者组消费进度监控">第二十二讲 消费者组消费进度监控</a>
      <ul>
        <li><a href="#使用命令行工具">使用命令行工具</a></li>
        <li><a href="#使用-java-consumer-api">使用 Java Consumer API</a></li>
        <li><a href="#使用jmx-监控指标">使用JMX 监控指标</a></li>
      </ul>
    </li>
    <li><a href="#第二十三讲-副本机制">第二十三讲 副本机制</a>
      <ul>
        <li><a href="#副本定义">副本定义</a></li>
        <li><a href="#副本角色">副本角色</a></li>
        <li><a href="#in-sync-replicas-isr">In-sync Replicas (ISR)</a></li>
        <li><a href="#unclean-领导者选举">Unclean 领导者选举</a></li>
      </ul>
    </li>
    <li><a href="#第二十四讲-请求处理过程">第二十四讲 请求处理过程</a>
      <ul>
        <li><a href="#数据类请求">数据类请求</a></li>
        <li><a href="#控制类请求">控制类请求</a></li>
      </ul>
    </li>
    <li><a href="#第二十五讲-重平衡过程">第二十五讲 重平衡过程</a></li>
    <li><a href="#相关链接">相关链接</a>
      <ul>
        <li><a href="#kafka管理和监控平台">kafka管理和监控平台</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h1 id="第一讲-消息系统-abc">第一讲 消息系统 ABC</h1>
<h2 id="定义">定义</h2>
<p>维基百科版: 消息系统是一组规范，利用这组规范在不同系统之间传递语义准确的消息，实现松耦合的异步数据传递。</p>
<h2 id="传输模型">传输模型</h2>
<ul>
<li>点对点</li>
<li>发布订阅</li>
</ul>
<h2 id="核心作用">核心作用</h2>
<ul>
<li>削峰填谷</li>
</ul>
<h1 id="第二讲-kafka-术语">第二讲 kafka 术语</h1>
<ul>
<li>Record: 消息</li>
<li>Topic: 主题</li>
<li>Partition: 分区，有序不变，每个主题至少有一个分区，从 0 开始</li>
<li>Offset: 分区位移，表示分区中消息的位置信息，单调递增且不变</li>
<li>Replica: 副本，每个分区可有多个副本，仅 Leader 副本对外提供服务，Follower 副本仅做数据备份</li>
<li>Producer: 生产者，发布信息</li>
<li>Consumer: 消息者，消费消息</li>
<li>Consumer Offset: 消费者位移，表示消费者消费进度</li>
<li>Consumer Group: 多个消费者组成一个组，共同消费一个主题，实现高吞吐</li>
<li>Rebalance: 重平衡，消费组某个成员挂掉后，其他消费者自动重新分配订阅主题的过程</li>
</ul>
<p>示意图如下：</p>
<p><img src="/image/kafka_in_action/2_1.webp" alt="term"></p>
<p>问：kafka 为什么不像 mysql 那样允许 follower 对外提供服务？</p>
<ul>
<li>kafka 使用不是典型的读多写少的场景</li>
<li>分区 Leader 分布在不同的 Broker 节点， 已提供了负载均衡的功能</li>
</ul>
<h1 id="第四讲-kafka-发现版本">第四讲 kafka 发现版本</h1>
<h2 id="apache-kafka">Apache Kafka</h2>
<p>社区版， 迭代速度快，社区响应度高</p>
<h2 id="confluent-kafka">Confluent Kafka</h2>
<p>kafka创始人创建的商业公司Confluent， 为 kafka 提供了很多高级特性， 如跨数据中心备份、集群监控</p>
<h2 id="cdhhdp-kafka">CDH/HDP Kafka</h2>
<p>大数据云公司提供版本，集成在数据平台中</p>
<h1 id="第六讲-线上集群部署">第六讲 线上集群部署</h1>
<h2 id="操作系统">操作系统</h2>
<p>kafka 客户端 在 Linux 上使用 epoll I/O 模型， 在 Windows 上使用 select</p>
<h2 id="磁盘">磁盘</h2>
<p>kafka 大多数场景 是顺序读写，使用机械磁盘可以胜任线上坏境</p>
<h2 id="磁盘容量">磁盘容量</h2>
<p>容量需要考虑如下因素</p>
<ul>
<li>新增消息数</li>
<li>平均消息大小</li>
<li>消息留存时间</li>
<li>备份数</li>
<li>是否启用压缩</li>
</ul>
<h2 id="带宽">带宽</h2>
<p>根据使用经验，超过 70% 带宽阈值就有网络丢包的可能性，</p>
<p><img src="/image/kafka_in_action/6_1.webp" alt="summary"></p>
<h1 id="第七讲-最最最重要集群参数上">第七讲 最最最重要集群参数（上）</h1>
<h2 id="broker-参数">Broker 参数</h2>
<h3 id="存储相关">存储相关</h3>
<ul>
<li>log.dirs: 指定目录 如 /home/kafka1,/home/kafka2, 多个目录可以实现故障转移Failover</li>
</ul>
<h3 id="zookeeper-相关">zookeeper 相关</h3>
<ul>
<li>zookeeper.connect: zk1:2181,zk2:2181,zk3:2181/kafka1</li>
</ul>
<h3 id="topic-管理相关">topic 管理相关</h3>
<ul>
<li>auto.create.topics.enable: 是否允许自动创建Topic</li>
<li>unclean.leader.election.enable: 是否运行 Unclean Leader 选举</li>
<li>auto.leader.rebalance.enable: 是否允许定期举行 Leader 选举</li>
</ul>
<h3 id="数据留存相关">数据留存相关</h3>
<ul>
<li>log.retention.{hours|minutes|ms}: 控制数据保留时长，默认hours=168</li>
<li>log.retention.bytes: 消息保存总容量大小，默认不限制</li>
<li>log.segment.bytes: 日志文件区块大小，默认 1GB （一个 partition 有 多个 segment 文件组成，不会删除最新的一个segment）</li>
<li>segment.ms: 日志文件毫秒周期，默认 7 天</li>
<li>message.max.bytes: 最大接受消息大小，默认1000012，976KB</li>
</ul>
<h1 id="第八讲-最最最重要集群参数下">第八讲 最最最重要集群参数（下）</h1>
<h2 id="topic-级别参数">Topic 级别参数</h2>
<ul>
<li>retention.ms: 消息保存时长，优先于Broker级别设置</li>
<li>retention.bytes: 消息保存大小，优先于与Broker级别设置</li>
</ul>
<h2 id="jvm-参数">JVM 参数</h2>
<ul>
<li>KAFKA_HEAP_OPTS: 堆大小， 建议设成 6G</li>
<li>KAFKA_JVM_PERFORMANCE_OPTS: GC参数</li>
</ul>
<h2 id="操作系统参数">操作系统参数</h2>
<ul>
<li>文件描述符限制： 使用 ulimit -n 1000000 改成一个较大值</li>
<li>文件系统类型：XFS 性能强于 ext4</li>
<li>Flush 落盘时间： 默认是 5s，可适当增大来降低物理磁盘的写操作</li>
</ul>
<h1 id="第九讲--消息分区机制原理">第九讲  消息分区机制原理</h1>
<h2 id="分区作用">分区作用</h2>
<p><img src="/image/kafka_in_action/9_1.webp" alt="topic_anatomy">
数据的读写操作是针对分区这个粒度进行的</p>
<p>分区的作用就是提供负载均衡的能力，实现系统的高伸缩性</p>
<h2 id="分区写入策略">分区写入策略</h2>
<h3 id="轮询策略">轮询策略</h3>
<p><img src="/image/kafka_in_action/9_2.webp" alt="round_robin"></p>
<p>默认策略，将消息平均分配到所有分区</p>
<h3 id="随机策略">随机策略</h3>
<p><img src="/image/kafka_in_action/9_3.webp" alt="random"></p>
<p>如果追求数据均匀分布， 优先使用轮询策略</p>
<h3 id="按消息键分配策略">按消息键分配策略</h3>
<p><img src="/image/kafka_in_action/9_4.webp" alt="hash_key_ordering"></p>
<p>键相同的消息会写入到同一个分区</p>
<h3 id="显式指定分区">显式指定分区</h3>
<p>kafka-python 可以支持</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">producer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;some_message_bytes&#39;</span><span class="p">,</span> <span class="n">partiion</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>kafka-go 需要实现对应接口达到类似效果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">CustomBalancer</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">kfk</span><span class="p">.</span><span class="nx">RoundRobin</span>
<span class="p">}</span>

<span class="c1">//nolint
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">CustomBalancer</span><span class="p">)</span> <span class="nf">Balance</span><span class="p">(</span><span class="nx">msg</span> <span class="nx">kfk</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="nx">partitions</span> <span class="o">...</span><span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Partition</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nx">RoundRobin</span><span class="p">.</span><span class="nf">Balance</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">partitions</span><span class="o">...</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Partition</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>消费者可以显式指定消费分区， 消费者组通过自平衡分配分区</p>
<h1 id="第十讲-压缩算法">第十讲 压缩算法</h1>
<h2 id="流程">流程</h2>
<p>Producer 端压缩、Broker 端 保持、Consumer 端解压缩</p>
<h2 id="压缩算法对比">压缩算法对比</h2>
<p><img src="/image/kafka_in_action/10_1.webp" alt="compression"></p>
<p>依据情况选择压缩比和吞吐率合适的算法</p>
<h1 id="第十一讲-无消息丢失配置">第十一讲 无消息丢失配置</h1>
<p>kafka 只对已提交的消息做有限度的持久化保证</p>
<h2 id="producer端">producer端</h2>
<ol>
<li>使用带回调的方法： send(msg, callback),</li>
<li>acks=-1 所有副本收到消息才算已提交</li>
<li>retries 设置一个较大值，在网络抖动失败时会重试消息发送 （重试可能导致消息乱序，max.in.flight.requests.per.connection=1可以避免）</li>
</ol>
<h2 id="broker-端">broker 端</h2>
<ol>
<li>unclean.leader.election.enable =  false 不让落后的broker 参与Leader选举</li>
<li>replication.factor &gt;= 3 消息多保持几份</li>
<li>min.insync.replicas &gt; 1 控制消息至少写入到多少分布才算已提交 （只在 acks=-1 是生效）</li>
</ol>
<h2 id="consumer-端">consumer 端</h2>
<ol>
<li>enable.auto.commit = false 手动提交维护</li>
</ol>
<h1 id="第十二讲-拦截器">第十二讲 拦截器</h1>
<p>生产者可以在发送消息前和提交成功后植入拦截器</p>
<p>消费者可以在消费消息前以及提交位移后植入拦截器</p>
<h1 id="第十四讲-幂等和事务">第十四讲 幂等和事务</h1>
<p>kafka 默认提供的可交付保障是至少一次 at lease once; 通过禁止重试可以实现至多一次 at most once</p>
<h2 id="幂等性-producer">幂等性 Producer</h2>
<p>通过设置 enable.idempotence = true 可以开启</p>
<p>开启以后，单分区单会话能够保证不会出现重复消息</p>
<p>背后的实现逻辑是 Broker 多保存数据，当 Producer 发送了相同字段的消息后，Broker
能够知晓消息重复了，并将其丢弃掉</p>
<h2 id="事务型-producer">事务型 Producer</h2>
<p>设置 enable.idempotence = true， 以及  transaction.id</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">producer</span><span class="o">.</span><span class="na">initTransactions</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
            <span class="n">producer</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
            <span class="n">producer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">record1</span><span class="o">);</span>
            <span class="n">producer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">record2</span><span class="o">);</span>
            <span class="n">producer</span><span class="o">.</span><span class="na">commitTransaction</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">KafkaException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">producer</span><span class="o">.</span><span class="na">abortTransaction</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面的代码能保证 Record1 和 Record2 要么全部成功，要么全部失败</p>
<p>事务可以保证跨分区、跨会话的幂等性</p>
<p>消费者端设置隔离级别 isolation.level = read_committed 后会只读取成功完成的事务消息</p>
<h1 id="第十五讲-消费者组">第十五讲 消费者组</h1>
<h2 id="特性">特性</h2>
<ol>
<li>consumer  group 可以有一个或多个 consumer</li>
<li>group id 是 consumer group 的唯一标识</li>
<li>单个分区只会分配到一个 consumer</li>
</ol>
<h2 id="实例数量设置">实例数量设置</h2>
<p>假设 一个 group 订阅了 3 个 topic, 每个 topic 有 2 个 partition, 那么设置
6 个实例能最大限度的利用kafka的高伸缩性，每个实例消费一个分区</p>
<h2 id="rebalance-触发条件">rebalance 触发条件</h2>
<ol>
<li>成员数量发生变化，增加或减少</li>
<li>订阅主题数量发生变更</li>
<li>主题分区数量变更</li>
</ol>
<h1 id="第十六讲-位移主题">第十六讲 位移主题</h1>
<p>__consumer_offsets 主要用来记录消费者的位移数据</p>
<p>当第一个 consumer  启动时，kafka 会自动创建位移主题，默认分区数 offsets.topic.num.partitions = 50 ，副本数 offsets.topic.replication.factor = 3</p>
<p>消费端位移提交分为手动和自动提交， 手动提交提供了灵活性和可控性，
而自动提交会定期地提交位移，即使没有新消息，这样会导致位移主题消息会越来越多，所以位移主题采用
log compaction 删除策略来删除重复消息</p>
<p><img src="/image/kafka_in_action/16_1.webp" alt="compaction"></p>
<h1 id="第十七讲-消费者组重平衡">第十七讲 消费者组重平衡</h1>
<p>重平衡就是消费者组中所有消费者就如何订阅主题分区达成共识的过程。
重平衡过程中，所有消费者不消费任何消息，在协调者 coordinator 的帮助下，完成订阅主题分区的分配。</p>
<p>broker 在启动时，会启动相应的 coordinator 组件，消费者组通过位移主题 __consumer_offsets
查找对应 coordinator 所在的 broker</p>
<p>消费者组所在 consumer_offsets 分区通过 <code>abs(hash(group_id) % topic_partition_count)</code> 计算可以得到</p>
<p>如何避免消费者被协调者错误移除？</p>
<ul>
<li>session.timeout.ms: 心跳超时时间， 建议设置成 6s</li>
<li>heartbeat.interval.ms: 心跳间隔，建议设置成 2s （即判定超时前能发送3轮心跳）</li>
<li>max.pool.interval.ms: 最大 poll 间隔， 根据业务消费时长设定，应大于消费时长</li>
<li>GC 参数： 频繁 GC 可能导致消费者停顿</li>
</ul>
<h1 id="第-18-讲-位移提交">第 18 讲 位移提交</h1>
<h2 id="自动提交">自动提交</h2>
<p>consumer 后台线程定时提交位移，相关参数</p>
<ul>
<li>enable.auto.commit = true (默认开启)</li>
<li>auto.commit.interval.ms = 5000 (最小提交间隔，默认5s)</li>
</ul>
<p>假设消费者每 5s 提交一次位移，在第 3s 时发生重平衡，那么前3s的数据会再重复消费一次</p>
<h1 id="手动提交">手动提交</h1>
<p>显式通过调用 <code>cosummer.commitSync()</code> 提交位移</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span>
                        <span class="n">consumer</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="n">1</span><span class="o">));</span>
            <span class="n">process</span><span class="o">(</span><span class="n">records</span><span class="o">);</span> <span class="c1">// 处理消息
</span><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
                        <span class="n">consumer</span><span class="o">.</span><span class="na">commitSync</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CommitFailedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">handle</span><span class="o">(</span><span class="n">e</span><span class="o">);</span> <span class="c1">// 处理提交失败异常
</span><span class="c1"></span>            <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>commitSync 是同步调用， 会阻塞线程，可以使用 commitAsync</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> 
  <span class="n">consumer</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="n">1</span><span class="o">));</span>
            <span class="n">process</span><span class="o">(</span><span class="n">records</span><span class="o">);</span> <span class="c1">// 处理消息
</span><span class="c1"></span>            <span class="n">consumer</span><span class="o">.</span><span class="na">commitAsync</span><span class="o">((</span><span class="n">offsets</span><span class="o">,</span> <span class="n">exception</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">handle</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>
  <span class="o">});</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以将两者结合，利用 commitSync 的重试规避瞬时错误，利用 commitAsync 来减少阻塞</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="k">try</span> <span class="o">{</span>
           <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> 
                                    <span class="n">consumer</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="n">1</span><span class="o">));</span>
                        <span class="n">process</span><span class="o">(</span><span class="n">records</span><span class="o">);</span> <span class="c1">// 处理消息
</span><span class="c1"></span>                        <span class="n">commitAysnc</span><span class="o">();</span> <span class="c1">// 使用异步提交规避阻塞
</span><span class="c1"></span>            <span class="o">}</span>
<span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handle</span><span class="o">(</span><span class="n">e</span><span class="o">);</span> <span class="c1">// 处理异常
</span><span class="c1"></span><span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
           <span class="k">try</span> <span class="o">{</span>
                        <span class="n">consumer</span><span class="o">.</span><span class="na">commitSync</span><span class="o">();</span> <span class="c1">// 最后一次提交使用同步阻塞式提交
</span><span class="c1"></span>            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                        <span class="n">consumer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="第二十一讲-java-版消费者-tcp-连接管理">第二十一讲 Java 版消费者 TCP 连接管理</h1>
<p>TCP 连接是在调用 KafkaConsumer.poll 方法被创建的。
poll 内部有三个时机可以创建 TCP 连接</p>
<h2 id="创建连接时机">创建连接时机</h2>
<ol>
<li>发起 FindCoordinator 请求时</li>
</ol>
<p>消费者启动时会向负载最小的 Broker 建立连接，请求告知主题对应的 coordinator Leader 在哪个 broker</p>
<ol start="2">
<li>连接协调者</li>
</ol>
<p>步骤 1 之后会和 coordinator 建立连接</p>
<ol start="3">
<li>消费数据时</li>
</ol>
<p>消费者会向每个分区 Leader 所在的 Broker 建立连接。</p>
<p>假设消费的 5 个分区在 4 个 Broker 上，那会建立 4 个连接。</p>
<h2 id="案例分析">案例分析</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"># 建立第一个连接，连接的Broker的 ID 是 -1， 表明还不知道其任何信息
[2019-05-27 10:00:54,142] DEBUG [Consumer clientId=consumer-1, groupId=test] Initiating connection to node localhost:9092 (id: -1 rack: null) using address localhost/127.0.0.1 (org.apache.kafka.clients.NetworkClient:944)

# 向第一个连接请求集群元数据信息
[2019-05-27 10:00:54,188] DEBUG [Consumer clientId=consumer-1, groupId=test] Sending metadata request MetadataRequestData(topics=[MetadataRequestTopic(name=&#39;t4&#39;)], allowAutoTopicCreation=true, includeClusterAuthorizedOperations=false, includeTopicAuthorizedOperations=false) to node localhost:9092 (id: -1 rack: null) (org.apache.kafka.clients.NetworkClient:1097)

# 向第一个连接发送 FindCoordinator 请求
[2019-05-27 10:00:54,188] TRACE [Consumer clientId=consumer-1, groupId=test] Sending FIND_COORDINATOR {key=test,key_type=0} with correlation id 0 to node -1 (org.apache.kafka.clients.NetworkClient:496)

# 收到 Coordinator 所在 Broker 信息
[2019-05-27 10:00:54,203] TRACE [Consumer clientId=consumer-1, groupId=test] Completed receive from node -1 for FIND_COORDINATOR with correlation id 0, received {throttle_time_ms=0,error_code=0,error_message=null, node_id=2,host=localhost,port=9094} (org.apache.kafka.clients.NetworkClient:837)

# 和 Coordinator 建立第二个连接
[2019-05-27 10:00:54,204] DEBUG [Consumer clientId=consumer-1, groupId=test] Initiating connection to node localhost:9094 (id: 2147483645 rack: null) using address localhost/127.0.0.1 (org.apache.kafka.clients.NetworkClient:944)

# 建立第三到五个连接，用于实际消息的获取，说明这三个 Broker 都有要消费的分区
[2019-05-27 10:00:54,237] DEBUG [Consumer clientId=consumer-1, groupId=test] Initiating connection to node localhost:9094 (id: 2 rack: null) using address localhost/127.0.0.1 (org.apache.kafka.clients.NetworkClient:944)
[2019-05-27 10:00:54,237] DEBUG [Consumer clientId=consumer-1, groupId=test] Initiating connection to node localhost:9092 (id: 0 rack: null) using address localhost/127.0.0.1 (org.apache.kafka.clients.NetworkClient:944)
[2019-05-27 10:00:54,238] DEBUG [Consumer clientId=consumer-1, groupId=test] Initiating connection to node localhost:9093 (id: 1 rack: null) using address localhost/127.0.0.1 (org.apache.kafka.clients.NetworkClient:944)
</code></pre></td></tr></table>
</div>
</div><p>总结上面的日志信息，可以看出消费者通常会创建三类连接：</p>
<ol>
<li>确认协调者和获取集群元数据</li>
<li>连接协调者，令其执行组成员管理操作</li>
<li>执行实际消息的获取</li>
</ol>
<p>当第三类连接建立后，第一类连接会被关闭，定期请求元数据的需求切换到第三类连接上。</p>
<p>问： 第三类连接是主题级别还是 Broker 级别 ？</p>
<h1 id="第二十二讲-消费者组消费进度监控">第二十二讲 消费者组消费进度监控</h1>
<p>消息滞后使用 Consumer Lag 衡量，假设当前生成了 20 万条消息，消费了 15 万条，那么
Consumer Lag 就等于 5 万。</p>
<h2 id="使用命令行工具">使用命令行工具</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ bin/kafka-consumer-groups.sh --bootstrap-server &lt;Kafka broker连接信息&gt; --describe --group &lt;group名称&gt;
</code></pre></td></tr></table>
</div>
</div><p><img src="/image/kafka_in_action/22_1.webp" alt="consumer_group_lag"></p>
<h2 id="使用-java-consumer-api">使用 Java Consumer API</h2>
<p>使用 AdminClient 查询</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="nf">lagOf</span><span class="o">(</span><span class="n">String</span> <span class="n">groupID</span><span class="o">,</span> <span class="n">String</span> <span class="n">bootstrapServers</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TimeoutException</span> <span class="o">{</span>
        <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
        <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CommonClientConfigs</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="n">bootstrapServers</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">(</span><span class="n">AdminClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">AdminClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">props</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">ListConsumerGroupOffsetsResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">listConsumerGroupOffsets</span><span class="o">(</span><span class="n">groupID</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">Map</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="o">,</span> <span class="n">OffsetAndMetadata</span><span class="o">&gt;</span> <span class="n">consumedOffsets</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">partitionsToOffsetAndMetadata</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
                <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ConsumerConfig</span><span class="o">.</span><span class="na">ENABLE_AUTO_COMMIT_CONFIG</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span> <span class="c1">// 禁止自动提交位移
</span><span class="c1"></span>                <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ConsumerConfig</span><span class="o">.</span><span class="na">GROUP_ID_CONFIG</span><span class="o">,</span> <span class="n">groupID</span><span class="o">);</span>
                <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ConsumerConfig</span><span class="o">.</span><span class="na">KEY_DESERIALIZER_CLASS_CONFIG</span><span class="o">,</span> <span class="n">StringDeserializer</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ConsumerConfig</span><span class="o">.</span><span class="na">VALUE_DESERIALIZER_CLASS_CONFIG</span><span class="o">,</span> <span class="n">StringDeserializer</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                <span class="k">try</span> <span class="o">(</span><span class="kd">final</span> <span class="n">KafkaConsumer</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KafkaConsumer</span><span class="o">&lt;&gt;(</span><span class="n">props</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">Map</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">endOffsets</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">endOffsets</span><span class="o">(</span><span class="n">consumedOffsets</span><span class="o">.</span><span class="na">keySet</span><span class="o">());</span>
                    <span class="k">return</span> <span class="n">endOffsets</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toMap</span><span class="o">(</span><span class="n">entry</span> <span class="o">-&gt;</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span>
                            <span class="n">entry</span> <span class="o">-&gt;</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">-</span> <span class="n">consumedOffsets</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">()).</span><span class="na">offset</span><span class="o">()));</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
                <span class="c1">// 处理中断异常
</span><span class="c1"></span>                <span class="c1">// ...
</span><span class="c1"></span>                <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyMap</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 处理ExecutionException
</span><span class="c1"></span>                <span class="c1">// ...
</span><span class="c1"></span>                <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyMap</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TimeoutException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">TimeoutException</span><span class="o">(</span><span class="s">&#34;Timed out when getting lag for consumer group &#34;</span> <span class="o">+</span> <span class="n">groupID</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="使用jmx-监控指标">使用JMX 监控指标</h2>
<p>使用 JMX 指标集成到 Grafana 等监控框架中</p>
<p>kafka 消费者 提供了名为 <code>kafka.consumer:type=consumer-fetch-manager-metrics,client-id=“{client-id}”</code> 指标</p>
<p>其中有两个指标和消费进度有关：</p>
<ul>
<li>records-lag-max</li>
<li>records-lead-min: 消费者位移和分区最旧消息的最小差值</li>
</ul>
<h1 id="第二十三讲-副本机制">第二十三讲 副本机制</h1>
<h2 id="副本定义">副本定义</h2>
<p>副本本质上是一个只能追加写消息的提交日志。</p>
<p>这些副本分散保存在不同的 Broker 上， 从而能够对抗 Broker 宕机带来的数据不可用。</p>
<p><img src="/image/kafka_in_action/23_1.webp" alt="replica1"></p>
<h2 id="副本角色">副本角色</h2>
<p><img src="/image/kafka_in_action/23_2.webp" alt="replica2"></p>
<p>副本分为两类，Leader 和 Follower， 分区在创建时会选出一个 Leader 副本， 其余副本成为 Follower。</p>
<p>所有的读写请求都由 Leader 处理，Follower 只是从 Leader 异步拉取消息从而实现同步</p>
<p>当 Leader 挂掉后，ZooKeeper 能够监控到并开启新一轮的选举</p>
<p>Follower 不对外提供服务的好处：</p>
<ol>
<li>方便实现 Read-your-writes 。如果从 Follower 读取消息，由于是异步的，可能看不到最新的消息</li>
<li>方便实现单调读 Monotonic Reads 。如果从多个副本读消息，可能出现某条消息一会存在一会不存在</li>
</ol>
<h2 id="in-sync-replicas-isr">In-sync Replicas (ISR)</h2>
<p>ISR 指与 Leader 同步的副本集合， Leader 本身也包括在 ISR 中</p>
<p>通过 replica.lag.time.max.ms 参数指定 Follower 能够落后 Leader 的最长时间，
在此范围内的 Follower 都在 ISR 中。</p>
<h2 id="unclean-领导者选举">Unclean 领导者选举</h2>
<p>当 ISR 为空时，只存在非同步副本。
unclean.leader.election.enable 参数控制是否允许 Unclean 领导者选举</p>
<p>开启的好处是使得 Leader 副本一直存在，提高可用性，但是可能会造成数据丢失，不建议开启。</p>
<h1 id="第二十四讲-请求处理过程">第二十四讲 请求处理过程</h1>
<p>kafka 定义了一组请求协议，用于实现各种交互操作，<code>PRODUCE</code>
请求用于生产消息，<code>FETCH</code>请求用于消费消息，<code>METADATA</code>请求用于获取集群元数据</p>
<h2 id="数据类请求">数据类请求</h2>
<p>kafka 使用 Reactor 模式处理请求</p>
<p><img src="/image/kafka_in_action/24_1.webp" alt="reactor"></p>
<p>Acceptor 线程用于分发请求，分发使用轮询模式</p>
<p>网络线程池来处理具体的请求，<code>num.network.threads</code> 参数控制线程数量，默认为3。</p>
<p>网络线程拿到请求后，将请求放入一个共享队列中，IO 线程池负责从队列中
取出请求，执行真正的处理。如果是 PRODUCE 请求，则将消息写入磁盘日志；
如果是 FETCH 请求，则从磁盘或页缓存中读取消息。</p>
<p>IO 线程处理完请求后， 会将响应发送到网络线程池的响应队列中，然后由
对应的网络线程将响应返回给客户端。</p>
<p><code>num.io.threads</code> 参数控制 IO 线程数量，默认为8。</p>
<p><img src="/image/kafka_in_action/24_2.webp" alt="io_thread_pool"></p>
<p>Purgatory 组件用来缓存延时请求。比如设置了 ack=all 的 PRODUCE 请求，
需要等待所有 ISR 副本接收后才能返回。</p>
<h2 id="控制类请求">控制类请求</h2>
<p>控制类请求用来执行特定的 kafka 内部动作，比如负责更新 Leader/Follower/ISR 的
<code>LeaderAndIsr</code> 请求、负责勒令副本下线的 <code>StopReplica</code> 请求。</p>
<p>kafka 将 控制类请求和数据类请求分类，分别创建了两套网络线程池和 IO 线程池</p>
<h1 id="第二十五讲-重平衡过程">第二十五讲 重平衡过程</h1>
<h1 id="相关链接">相关链接</h1>
<h2 id="kafka管理和监控平台">kafka管理和监控平台</h2>
<ul>
<li><a href="https://github.com/smartloli/EFAK">A easy and high-performance monitoring system</a></li>
<li><a href="https://github.com/xaecbd/KCenter">A unified platform for kafka cluster management</a></li>
<li><a href="https://github.com/didi/LogiKM">一站式Apache Kafka集群指标监控与运维管控平台</a></li>
</ul>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">PPD</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2022-07-01
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://ppd0705.github.io/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/getting_started_with_k8s/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">[笔记]k8s入门（更新中）</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/learn_supervisor/">
            <span class="next-text nav-default">supervisor 源码解读</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "ppd0705/ppd0705.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="ppd0705@icloud.com" rel="me noopener" class="iconfont"
      title="email"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/ppd0705" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://github.com/ppd0705" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/ppd0705/" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>


<a href="https://ppd0705.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2019 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        PPD
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
