<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>[笔记]Go项目开发实战 - PPD&#39;s blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="PPD" />
  <meta name="description" content="第一讲 开源规范 开源协议概述 MIT是相对自由开发的协议 第二讲 文档规范 最重要的三类文档：README文档、项目文档和API文档 README规范 主" />

  <meta name="keywords" content="PPD, blog" />






<meta name="generator" content="Hugo 0.86.0-DEV" />


<link rel="canonical" href="https://ppd0705.github.io/post/go_develop_in_action/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="[笔记]Go项目开发实战" />
<meta property="og:description" content="第一讲 开源规范 开源协议概述 MIT是相对自由开发的协议 第二讲 文档规范 最重要的三类文档：README文档、项目文档和API文档 README规范 主" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ppd0705.github.io/post/go_develop_in_action/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-06-28T07:28:37+08:00" />
<meta property="article:modified_time" content="2021-06-28T07:28:37+08:00" />

<meta itemprop="name" content="[笔记]Go项目开发实战">
<meta itemprop="description" content="第一讲 开源规范 开源协议概述 MIT是相对自由开发的协议 第二讲 文档规范 最重要的三类文档：README文档、项目文档和API文档 README规范 主"><meta itemprop="datePublished" content="2021-06-28T07:28:37+08:00" />
<meta itemprop="dateModified" content="2021-06-28T07:28:37+08:00" />
<meta itemprop="wordCount" content="18150">
<meta itemprop="keywords" content="Golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[笔记]Go项目开发实战"/>
<meta name="twitter:description" content="第一讲 开源规范 开源协议概述 MIT是相对自由开发的协议 第二讲 文档规范 最重要的三类文档：README文档、项目文档和API文档 README规范 主"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">PPD's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/about">About</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      PPD's blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://ppd0705.github.io/about">About</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">[笔记]Go项目开发实战</h1>
      
      <div class="post-meta">
        <time datetime="2021-06-28" class="post-time">
          2021-06-28
        </time>
        <div class="post-category">
            <a href="https://ppd0705.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/"> 计算机 </a>
            
          </div>
        <span class="more-meta"> 18150 words </span>
          <span class="more-meta"> 37 min read </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#第一讲-开源规范">第一讲 开源规范</a>
      <ul>
        <li><a href="#开源协议概述">开源协议概述</a></li>
      </ul>
    </li>
    <li><a href="#第二讲-文档规范">第二讲 文档规范</a>
      <ul>
        <li><a href="#readme规范">README规范</a></li>
        <li><a href="#项目文档规范">项目文档规范</a></li>
        <li><a href="#api接口规范">API接口规范</a></li>
      </ul>
    </li>
    <li><a href="#第三讲-版本规范">第三讲 版本规范</a></li>
    <li><a href="#第四讲-commit规范">第四讲 Commit规范</a>
      <ul>
        <li><a href="#header">Header</a></li>
        <li><a href="#body">Body</a></li>
        <li><a href="#footer">Footer</a></li>
        <li><a href="#revert-commit">Revert Commit</a></li>
        <li><a href="#其他">其他</a></li>
      </ul>
    </li>
    <li><a href="#第五讲-目录结构设计">第五讲 目录结构设计</a>
      <ul>
        <li><a href="#目录介绍">目录介绍</a>
          <ul>
            <li><a href="#1-web">1. /web</a></li>
            <li><a href="#2-cmd">2. /cmd</a></li>
            <li><a href="#3-internal">3. /internal</a></li>
            <li><a href="#4-pkg">4. /pkg</a></li>
            <li><a href="#5-vendor">5. /vendor</a></li>
            <li><a href="#6-third_party">6. /third_party</a></li>
            <li><a href="#7-test">7. /test</a></li>
            <li><a href="#8-configs">8. /configs</a></li>
            <li><a href="#9-deployments">9. /deployments</a></li>
            <li><a href="#10-init">10. /init</a></li>
            <li><a href="#11-makefile">11. /Makefile</a></li>
            <li><a href="#12-scripts">12. /scripts</a></li>
            <li><a href="#13-build">13. /build</a></li>
            <li><a href="#14-tools">14. /tools</a></li>
            <li><a href="#15-githooks">15. /githooks</a></li>
            <li><a href="#16-assets">16. /assets</a></li>
            <li><a href="#17-website">17. /website</a></li>
            <li><a href="#18-readmemd">18. /README.md</a></li>
            <li><a href="#19-docs">19. /docs</a></li>
            <li><a href="#20-contributingmd">20. /CONTRIBUTING.md</a></li>
            <li><a href="#21-api">21. /api</a></li>
            <li><a href="#22-license">22. /LICENSE</a></li>
            <li><a href="#23-changelog">23. /CHANGELOG</a></li>
            <li><a href="#24-examples">24. /examples</a></li>
          </ul>
        </li>
        <li><a href="#其他建议">其他建议</a></li>
      </ul>
    </li>
    <li><a href="#第六讲-工作流设计">第六讲 工作流设计</a>
      <ul>
        <li><a href="#功能分支工作流">功能分支工作流</a></li>
        <li><a href="#git-flow工作流">Git Flow工作流</a></li>
        <li><a href="#forking工作流">Forking工作流</a></li>
      </ul>
    </li>
    <li><a href="#第七讲-研发流程设计">第七讲 研发流程设计</a>
      <ul>
        <li><a href="#研发流程">研发流程</a></li>
        <li><a href="#研发模式">研发模式</a>
          <ul>
            <li><a href="#瀑布模式">瀑布模式</a></li>
            <li><a href="#迭代模式">迭代模式</a></li>
            <li><a href="#敏捷模式">敏捷模式</a></li>
          </ul>
        </li>
        <li><a href="#cicd">CI/CD</a>
          <ul>
            <li><a href="#持续集成">持续集成</a></li>
            <li><a href="#持续交付">持续交付</a></li>
            <li><a href="#持续部署">持续部署</a></li>
          </ul>
        </li>
        <li><a href="#devops">DevOps</a>
          <ul>
            <li><a href="#chatops">ChatOps</a></li>
            <li><a href="#gitops">GitOps</a></li>
            <li><a href="#aiops">AIOps</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第八讲-设计方法">第八讲 设计方法</a>
      <ul>
        <li><a href="#代码结构">代码结构</a></li>
        <li><a href="#代码规范">代码规范</a></li>
        <li><a href="#代码质量">代码质量</a></li>
        <li><a href="#编程哲学">编程哲学</a></li>
        <li><a href="#软件设计方法">软件设计方法</a></li>
        <li><a href="#高效项目管理">高效项目管理</a></li>
      </ul>
    </li>
    <li><a href="#第九讲-设计模式">第九讲 设计模式</a>
      <ul>
        <li><a href="#创建型模式">创建型模式</a>
          <ul>
            <li><a href="#单例模式">单例模式</a></li>
            <li><a href="#工厂模式">工厂模式</a></li>
          </ul>
        </li>
        <li><a href="#结构型模式">结构型模式</a>
          <ul>
            <li><a href="#策略模式">策略模式</a></li>
            <li><a href="#模板模式">模板模式</a></li>
          </ul>
        </li>
        <li><a href="#行为型模式">行为型模式</a>
          <ul>
            <li><a href="#代理模式">代理模式</a></li>
            <li><a href="#选项模式">选项模式</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第十讲-api风格">第十讲 API风格</a>
      <ul>
        <li><a href="#restful-api设计原则">Restful API设计原则</a>
          <ul>
            <li><a href="#uri设计">URI设计</a></li>
            <li><a href="#操作和方法之间的映射">操作和方法之间的映射</a></li>
            <li><a href="#统一分页过滤排序搜索功能">统一分页/过滤/排序/搜索功能</a></li>
            <li><a href="#域名">域名</a></li>
          </ul>
        </li>
        <li><a href="#rpc-api">RPC API</a></li>
      </ul>
    </li>
    <li><a href="#第十一讲-makefile">第十一讲 Makefile</a>
      <ul>
        <li><a href="#基本形式">基本形式</a></li>
        <li><a href="#基本语法">基本语法</a>
          <ul>
            <li><a href="#声明伪目标">声明伪目标</a></li>
            <li><a href="#关闭回声">关闭回声</a></li>
            <li><a href="#忽略错误">忽略错误</a></li>
            <li><a href="#通配符">通配符</a></li>
          </ul>
        </li>
        <li><a href="#变量和赋值">变量和赋值</a>
          <ul>
            <li><a href="#自动变量">自动变量</a></li>
          </ul>
        </li>
        <li><a href="#条件语句">条件语句</a></li>
        <li><a href="#循环语句">循环语句</a></li>
        <li><a href="#内置函数">内置函数</a></li>
      </ul>
    </li>
    <li><a href="#第十二讲-流程管理">第十二讲 流程管理</a>
      <ul>
        <li><a href="#静态代码检查">静态代码检查</a></li>
        <li><a href="#swagger文档生成">swagger文档生成</a></li>
      </ul>
    </li>
    <li><a href="#第十三讲-错误处理">第十三讲 错误处理</a>
      <ul>
        <li><a href="#https-code">HTTPS CODE</a></li>
        <li><a href="#错误码设计">错误码设计</a></li>
        <li><a href="#错误包设计">错误包设计</a></li>
        <li><a href="#需求">需求</a></li>
        <li><a href="#实现">实现</a>
          <ul>
            <li><a href="#增加withcode结构体">增加WithCode结构体</a></li>
          </ul>
        </li>
        <li><a href="#错误码实现">错误码实现</a></li>
      </ul>
    </li>
    <li><a href="#第十四讲-日志包设计">第十四讲 日志包设计</a>
      <ul>
        <li><a href="#基础功能">基础功能</a></li>
        <li><a href="#高级功能">高级功能</a></li>
        <li><a href="#可选功能">可选功能</a></li>
        <li><a href="#关注点">关注点</a></li>
        <li><a href="#分布式日志解决方法efk">分布式日志解决方法（EFK）</a></li>
      </ul>
    </li>
    <li><a href="#第十五讲-日志包实现">第十五讲 日志包实现</a>
      <ul>
        <li><a href="#优先开源日志包">优先开源日志包</a></li>
      </ul>
    </li>
    <li><a href="#第十六讲-web服务核心功能">第十六讲 Web服务核心功能</a></li>
    <li><a href="#第十七讲-认证机制">第十七讲 认证机制</a>
      <ul>
        <li><a href="#认证和授权的区别">认证和授权的区别</a></li>
        <li><a href="#四种基本的认证方式">四种基本的认证方式</a>
          <ul>
            <li><a href="#basic">Basic</a></li>
            <li><a href="#digest">Digest</a></li>
            <li><a href="#oauth">OAuth</a>
              <ul>
                <li><a href="#密码式">密码式</a></li>
                <li><a href="#隐藏式">隐藏式</a></li>
                <li><a href="#凭借式">凭借式</a></li>
                <li><a href="#授权码式">授权码式</a></li>
              </ul>
            </li>
            <li><a href="#bearer">Bearer</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第十八讲-iam的认证功能设计">第十八讲 IAM的认证功能设计</a>
      <ul>
        <li><a href="#整体思路">整体思路</a></li>
        <li><a href="#具体设计">具体设计</a></li>
        <li><a href="#具体实现">具体实现</a></li>
      </ul>
    </li>
    <li><a href="#第十九讲-权限模型">第十九讲 权限模型</a>
      <ul>
        <li><a href="#常见权限模型">常见权限模型</a>
          <ul>
            <li><a href="#权限控制列表">权限控制列表</a></li>
            <li><a href="#自主访问控制">自主访问控制</a></li>
            <li><a href="#强制访问控制">强制访问控制</a></li>
            <li><a href="#基于角色的访问控制">基于角色的访问控制</a>
              <ul>
                <li><a href="#rbac0">RBAC0</a></li>
                <li><a href="#rbac1">RBAC1</a></li>
                <li><a href="#rbac2">RBAC2</a></li>
                <li><a href="#rbac3">RBAC3</a></li>
              </ul>
            </li>
            <li><a href="#基于属性的权限验证">基于属性的权限验证</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第二十讲-iam-apiserver设计">第二十讲 iam-apiserver设计</a>
      <ul>
        <li><a href="#功能介绍">功能介绍</a>
          <ul>
            <li><a href="#认证相关接口">认证相关接口</a></li>
            <li><a href="#用户相关接口">用户相关接口</a></li>
            <li><a href="#秘钥相关接口">秘钥相关接口</a></li>
            <li><a href="#策略相关接口">策略相关接口</a></li>
          </ul>
        </li>
        <li><a href="#代码实现">代码实现</a>
          <ul>
            <li><a href="#配置处理">配置处理</a></li>
            <li><a href="#启动流程">启动流程</a></li>
            <li><a href="#请求处理">请求处理</a></li>
            <li><a href="#代码架构">代码架构</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第二十一讲-iam-apiserver核心功能实现">第二十一讲 iam-apiserver核心功能实现</a>
      <ul>
        <li><a href="#应用框架相关">应用框架相关</a>
          <ul>
            <li><a href="#优雅关停">优雅关停</a>
              <ul>
                <li><a href="#方式1">方式1</a></li>
                <li><a href="#方式2">方式2</a></li>
              </ul>
            </li>
            <li><a href="#健康检查">健康检查</a></li>
            <li><a href="#插件化加载中间件">插件化加载中间件</a></li>
          </ul>
        </li>
        <li><a href="#编程规范相关">编程规范相关</a>
          <ul>
            <li><a href="#api版本">API版本</a></li>
            <li><a href="#统一资源元数据">统一资源元数据</a>
              <ul>
                <li><a href="#公共属性介绍">公共属性介绍</a></li>
              </ul>
            </li>
            <li><a href="#统一返回">统一返回</a></li>
            <li><a href="#并发处理">并发处理</a></li>
          </ul>
        </li>
        <li><a href="#其他-1">其他</a>
          <ul>
            <li><a href="#插件化选择json库">插件化选择JSON库</a></li>
            <li><a href="#调用链实现">调用链实现</a></li>
            <li><a href="#数据一致性">数据一致性</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第二十二讲-gorm介绍">第二十二讲 GORM介绍</a>
      <ul>
        <li><a href="#常用操作">常用操作</a>
          <ul>
            <li><a href="#模型定义">模型定义</a></li>
            <li><a href="#连接数据库">连接数据库</a></li>
            <li><a href="#创建记录">创建记录</a></li>
            <li><a href="#删除记录">删除记录</a></li>
            <li><a href="#更新记录">更新记录</a></li>
            <li><a href="#查询记录">查询记录</a></li>
            <li><a href="#钩子">钩子</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第二十三讲-数据流服务-authz-server-设计">第二十三讲 数据流服务 authz-server 设计</a>
      <ul>
        <li><a href="#访问控制策略库-ladon">访问控制策略库 ladon</a></li>
        <li><a href="#authz-server-代码实现">authz-server 代码实现</a>
          <ul>
            <li><a href="#启动流程-1">启动流程</a></li>
            <li><a href="#api请求处理流程">API请求处理流程</a></li>
            <li><a href="#代码架构-1">代码架构</a></li>
            <li><a href="#缓存更新">缓存更新</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第二十四讲-数据采集">第二十四讲 数据采集</a>
      <ul>
        <li><a href="#功能设计">功能设计</a></li>
        <li><a href="#功能实现">功能实现</a>
          <ul>
            <li><a href="#数据上报">数据上报</a></li>
            <li><a href="#数据采集">数据采集</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第二十五讲-公有云sdk设计">第二十五讲 公有云SDK设计</a>
      <ul>
        <li><a href="#目录结构">目录结构</a></li>
        <li><a href="#设计方法">设计方法</a></li>
      </ul>
    </li>
    <li><a href="#第二十六讲-iam-sdk设计">第二十六讲 IAM SDK设计</a>
      <ul>
        <li><a href="#设计思路">设计思路</a></li>
        <li><a href="#使用实例">使用实例</a>
          <ul>
            <li><a href="#项目级客户端">项目级客户端</a></li>
            <li><a href="#应用级客户端">应用级客户端</a></li>
            <li><a href="#服务级客户端">服务级客户端</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第二十七讲-iam-命令行工具设计">第二十七讲 IAM 命令行工具设计</a>
      <ul>
        <li><a href="#大型系统客户端的特点">大型系统客户端的特点</a></li>
        <li><a href="#iamctl核心实现">iamctl核心实现</a></li>
      </ul>
    </li>
    <li><a href="#第二十八讲-如何编写单元测试和性能测试用例">第二十八讲 如何编写单元测试和性能测试用例</a>
      <ul>
        <li><a href="#单元测试">单元测试</a></li>
        <li><a href="#性能测试">性能测试</a></li>
      </ul>
    </li>
    <li><a href="#第二十九讲-iam测试介绍">第二十九讲 IAM测试介绍</a>
      <ul>
        <li><a href="#示例测试">示例测试</a></li>
        <li><a href="#testmain-函数">TestMain 函数</a></li>
        <li><a href="#mock测试">Mock测试</a>
          <ul>
            <li><a href="#生成方式">生成方式</a></li>
            <li><a href="#编写测试用例">编写测试用例</a></li>
          </ul>
        </li>
        <li><a href="#fake测试">Fake测试</a></li>
        <li><a href="#何时编写和执行单元测试">何时编写和执行单元测试</a></li>
        <li><a href="#测试覆盖率">测试覆盖率</a></li>
        <li><a href="#iam如何运行测试">IAM如何运行测试</a></li>
      </ul>
    </li>
    <li><a href="#第三十讲-如何分析go语言代码性能">第三十讲 如何分析Go语言代码性能</a>
      <ul>
        <li><a href="#生成性能数据文件">生成性能数据文件</a>
          <ul>
            <li><a href="#命令行生成">命令行生成</a></li>
            <li><a href="#代码生成">代码生成</a></li>
            <li><a href="#nethttppprof包生成">net/http/pprof包生成</a></li>
          </ul>
        </li>
        <li><a href="#性能分析">性能分析</a>
          <ul>
            <li><a href="#cpu性能分析">CPU性能分析</a></li>
            <li><a href="#内存性能分析">内存性能分析</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第三十一讲-apiserver性能测试和调优">第三十一讲 APIServer性能测试和调优</a>
      <ul>
        <li><a href="#api性能测试指标">API性能测试指标</a></li>
        <li><a href="#api性能测试方法">API性能测试方法</a></li>
        <li><a href="#api接口性能标准参考">API接口性能标准参考</a></li>
        <li><a href="#性能测试注意事项">性能测试注意事项</a>
          <ul>
            <li><a href="#web框架性能">Web框架性能</a></li>
            <li><a href="#api框架性能">API框架性能</a></li>
            <li><a href="#测试环境">测试环境</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h1 id="第一讲-开源规范">第一讲 开源规范</h1>
<h2 id="开源协议概述">开源协议概述</h2>
<p>MIT是相对自由开发的协议</p>
<p><img src="/image/go_develop_in_action/4_1.png" alt="opensource_proctol"></p>
<h1 id="第二讲-文档规范">第二讲 文档规范</h1>
<p>最重要的三类文档：README文档、项目文档和API文档</p>
<h2 id="readme规范">README规范</h2>
<p>主要用来介绍项目的功能、安装、部署和使用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"># 项目名称

&lt;!-- 写一段简短的话描述项目 --&gt;

# 功能特性

&lt;!-- 描述该项目的核心功能点 --&gt;

# 软件架构(可选)

&lt;!-- 可以描述下项目的架构 --&gt;

# 快速开始

# 依赖检查

&lt;!-- 描述该项目的依赖，比如依赖的包、工具或者其他任何依赖项 --&gt;

# 构建

&lt;!-- 描述如何构建该项目 --&gt;

# 运行

&lt;!-- 描述如何运行该项目 --&gt;

# 使用指南

&lt;!-- 描述如何使用该项目 --&gt;

# 如何贡献

&lt;!-- 告诉其他开发者如果给该项目贡献源码 --&gt;

# 社区(可选)

&lt;!-- 如果有需要可以介绍一些社区相关的内容 --&gt;

# 关于作者

&lt;!-- 这里写上项目作者 --&gt;

# 谁在用(可选)

&lt;!-- 可以列出使用本项目的其他有影响力的项目，算是给项目打个广告吧 --&gt;

# 许可证

&lt;!-- 这里链接上该项目的开源许可证 --&gt;
</code></pre></td></tr></table>
</div>
</div><h2 id="项目文档规范">项目文档规范</h2>
<p>通常放在<code>/docs</code>目录下，包含开发文档和用户文档</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-path" data-lang="path"><span class="err">docs</span>
<span class="err">├──</span> <span class="err">devel</span>                            <span class="c"># 开发文档，可以提前规划好，英文版文档和中文版文档</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="err">en-US/</span>                       <span class="c"># 英文版文档，可以根据需要组织文件结构</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="err">zh-CN</span>                        <span class="c"># 中文版文档，可以根据需要组织文件结构</span>
<span class="err">│</span>       <span class="err">└──</span> <span class="err">development.md</span>           <span class="c"># 开发手册，可以说明如何编译、构建、运行项目</span>
<span class="err">├──</span> <span class="err">guide</span>                            <span class="c"># 用户文档</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="err">en-US/</span>                       <span class="c"># 英文版文档，可以根据需要组织文件结构</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="err">zh-CN</span>                        <span class="c"># 中文版文档，可以根据需要组织文件结构</span>
<span class="err">│</span>       <span class="err">├──</span> <span class="err">api/</span>                     <span class="c"># API文档</span>
<span class="err">│</span>       <span class="err">├──</span> <span class="err">best-practice</span>            <span class="c"># 最佳实践，存放一些比较重要的实践文章</span>
<span class="err">│</span>       <span class="err">│</span>   <span class="err">└──</span> <span class="err">authorization.md</span>
<span class="err">│</span>       <span class="err">├──</span> <span class="err">faq</span>                      <span class="c"># 常见问题</span>
<span class="err">│</span>       <span class="err">│</span>   <span class="err">├──</span> <span class="err">iam-apiserver</span>
<span class="err">│</span>       <span class="err">│</span>   <span class="err">└──</span> <span class="err">installation</span>
<span class="err">│</span>       <span class="err">├──</span> <span class="err">installation</span>             <span class="c"># 安装文档</span>
<span class="err">│</span>       <span class="err">│</span>   <span class="err">└──</span> <span class="err">installation.md</span>
<span class="err">│</span>       <span class="err">├──</span> <span class="err">introduction/</span>            <span class="c"># 产品介绍文档</span>
<span class="err">│</span>       <span class="err">├──</span> <span class="err">operation-guide</span>          <span class="c"># 操作指南，里面可以根据RESTful资源再划分为更细的子目录，用来存放系统核心/全部功能的操作手册</span>
<span class="err">│</span>       <span class="err">│</span>   <span class="err">├──</span> <span class="err">policy.md</span>
<span class="err">│</span>       <span class="err">│</span>   <span class="err">├──</span> <span class="err">secret.md</span>
<span class="err">│</span>       <span class="err">│</span>   <span class="err">└──</span> <span class="err">user.md</span>
<span class="err">│</span>       <span class="err">├──</span> <span class="err">quickstart</span>               <span class="c"># 快速入门</span>
<span class="err">│</span>       <span class="err">│</span>   <span class="err">└──</span> <span class="err">quickstart.md</span>
<span class="err">│</span>       <span class="err">├──</span> <span class="err">README.md</span>                <span class="c"># 用户文档入口文件</span>
<span class="err">│</span>       <span class="err">└──</span> <span class="err">sdk</span>                      <span class="c"># SDK文档</span>
<span class="err">│</span>           <span class="err">└──</span> <span class="err">golang.md</span>
<span class="err">└──</span> <span class="err">images</span>                           <span class="c"># 图片存放目录</span>
    <span class="err">└──</span> <span class="err">部署架构v1.png</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="api接口规范">API接口规范</h2>
<p>API文档生成方式包括通过注释生成、编写Markdown格式文档, 通常拆分为多个文件</p>
<ul>
<li>README: API介绍整体文档</li>
<li>CHANGELOG: PAI变更历史</li>
<li>generic: 通用的请求参数、返回参数、认证方法、响应状态码等说明</li>
<li>struct: 接口使用的数据结构</li>
<li>error_code: 业务错误码说明</li>
<li>按资源划分API文档： API详细说明</li>
</ul>
<h1 id="第三讲-版本规范">第三讲 版本规范</h1>
<p>版本格式为：主版本号.次版本号.修订号（X.Y.Z）</p>
<p>版本号递增规则</p>
<ul>
<li>主版本（major）: 不兼容API修改</li>
<li>次版本（minor）: 新增功能（一般偶数为稳定版，奇数为开发版本）</li>
<li>修订版本：问题修正</li>
</ul>
<p>版本号建议</p>
<ul>
<li>开始开发时，以0.1.0作为第一个开发版本号，后续发行时递增次版本号</li>
<li>发布第一个稳定版时定为1.0.0</li>
<li>后续迭代
<ul>
<li>fix commit将修订版本+1</li>
<li>feat commit将次版本号+1</li>
<li>BREAKING CHANGE commit将主版本号+1</li>
</ul>
</li>
</ul>
<p><img src="/image/go_develop_in_action/5_1.webp" alt="commit_types"></p>
<h1 id="第四讲-commit规范">第四讲 Commit规范</h1>
<p>采用Angular风格的Commit Message, 其包含三个部分：Header、Body和Footer，具体格式如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">&lt;type&gt;[optional scope]: &lt;description&gt;
// blank line
[optional body]
// blink line
[optional footer]
</code></pre></td></tr></table>
</div>
</div><h2 id="header">Header</h2>
<p><code>type</code>说明commit类型，主要分为Development和Production两大类</p>
<ul>
<li>Development类别修改的是项目管理类的变更，如CI流程、构建方式等，不会影响到最终用户，具体类型
<ul>
<li>style：代码格式类的变更，如格式化代码、删除空行等</li>
<li>test： 增加或更新测试用例</li>
<li>ci：持续集成和部署相关的改动</li>
<li>docs：更新文档</li>
<li>chore：其他类型，如构建流程、依赖管理或辅助工具的变更等</li>
</ul>
</li>
<li>Production类别会影响到最终用户，提交前需要做好充分的测试
<ul>
<li>feat: 新增功能</li>
<li>fix: bug修复</li>
<li>perf: 提高代码性能的变更</li>
<li>refactor: 不属于上面三类的其他类型，如简化代码、重命名变量等</li>
</ul>
</li>
</ul>
<p><code>scope</code>用来说明影响范围，应根据项目情况设计大类如api、pkg、docs等</p>
<p><code>descrption</code>是对commit的简单描述，必须以动词开头，使用现在时态，结尾不加句号</p>
<h2 id="body">Body</h2>
<p>body是对commit的详细描述，同样以动词开头，使用现在时态，内容包含改动的原因和改动点</p>
<h2 id="footer">Footer</h2>
<p>通产用来说明不兼容的改动和关闭的issue，如下示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">BREAKING CHANGE: XXXXX
Cloes: #123, #234
</code></pre></td></tr></table>
</div>
</div><h2 id="revert-commit">Revert Commit</h2>
<p>当还原commit的时，在还原的Header前面加<code>revert: </code>, Body里面说明还原的commit hash，如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">revert: feat(api): add &#39;Host&#39; option

This reverts commit fjsdf34353534vdf
</code></pre></td></tr></table>
</div>
</div><h2 id="其他">其他</h2>
<p>合并提交： 对于过多的commit使用<code>git rebase</code>进行合并</p>
<p>修改message: 使用<code>git rebase</code>(注：修改message会将导致当前及置换的hash变更)</p>
<p>自动化工具:</p>
<ul>
<li><a href="https://github.com/lintingzhen/commitizen-go">commitizen-go</a>：格式化填充commit message</li>
<li><a href="https://github.com/llorllale/go-gitlint">gitlint</a>: 检查commit message</li>
<li><a href="https://github.com/git-chglog/git-chglog">git-changelog</a>: 自动生成change log</li>
<li><a href="https://github.com/arnaud-deprez/gsemver">gmemver</a>: 语义化版本自动生成</li>
</ul>
<h1 id="第五讲-目录结构设计">第五讲 目录结构设计</h1>
<p><img src="/image/go_develop_in_action/6_1.webp" alt="project-layer"></p>
<h2 id="目录介绍">目录介绍</h2>
<h3 id="1-web">1. /web</h3>
<p>web目录主要存放web静态资源</p>
<h3 id="2-cmd">2. /cmd</h3>
<p>一个项目可能有多个组件，每个组件的main函数所在文件夹放在该目录</p>
<h3 id="3-internal">3. /internal</h3>
<p>存放私有应用的代码，不能被其他项目导入</p>
<p>项目内应用之间共享代码存放于/internal/pkg</p>
<p>开发建议：最开始将共享代码都放/internal/pkg，做好对外发布的准备时再转到/pkg目录</p>
<p>IAM项目internal目录结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">├── apiserver
│   ├── api
│   │   └── v1
│   │       └── user
│   ├── options
│   ├── config
│   ├── service
│   │   └── user.go
│   ├── store
│   │   ├── mysql
│   │   │   └── user.go
│   │   ├── fake
│   └── testing
├── authzserver
│   ├── api
│   │   └── v1
│   ├── options
│   ├── store
│   └── testing
├── iamctl
│   ├── cmd
│   │   ├── cmd.go
│   │   ├── info
└── pkg
    ├── code
    ├── middleware
    ├── options
    └── validation
</code></pre></td></tr></table>
</div>
</div><p>主要分为三大类</p>
<ul>
<li>/internal/pkg: 内部共享包存放目录</li>
<li>/internal/iamctl: 对于大型项目，可能会存在客户端工具</li>
<li>/internal/apiserver: 应用目录</li>
</ul>
<p>针对具体的应用目录，也会根据功能来划分：</p>
<ul>
<li>/internal/apiserver/api/v1: HTTP API接口具体实现</li>
<li>/internal/apiserver/options: command flag</li>
<li>/internal/apiserver/service: 业务逻辑代码</li>
<li>/internal/apiserver/store/mysql: 数据库交互</li>
</ul>
<p>/internal/pkg通常也会划分：</p>
<ul>
<li>/internal/pkg/code: 业务Code码</li>
<li>/internal/pkg/validation: 通用验证函数</li>
<li>/internal/pkg/code: HTTP处理链</li>
</ul>
<h3 id="4-pkg">4. /pkg</h3>
<p>pkg目录存放外部应用可以使用的代码库，应谨慎考虑</p>
<h3 id="5-vendor">5. /vendor</h3>
<p>项目依赖，通过<code>go mod vendor</code>创建</p>
<h3 id="6-third_party">6. /third_party</h3>
<p>外部帮助工具，比如fork了一个第三方go包，并做了小改动，可以放置该目录</p>
<h3 id="7-test">7. /test</h3>
<p>存放其他外部测试应用和测试数据</p>
<h3 id="8-configs">8. /configs</h3>
<p>存放配置文件模板或默认配置</p>
<h3 id="9-deployments">9. /deployments</h3>
<p>存放系统和容器编排部署模板和配置</p>
<h3 id="10-init">10. /init</h3>
<p>存放初始化系统和进程管理配置文件，如systemd、supervisord等</p>
<h3 id="11-makefile">11. /Makefile</h3>
<p>项目管理文件</p>
<h3 id="12-scripts">12. /scripts</h3>
<p>存放脚本文件，通常可能分为三个目录</p>
<ul>
<li>/scripts/make-rules: 存放maker文件，实现Makerfile文件中的各个功能</li>
<li>/scripts/lib: 存放shell脚本</li>
<li>/scripts/intall: 如果项目支持自动化部署，可以将部署脚本放在该目录</li>
</ul>
<h3 id="13-build">13. /build</h3>
<p>存放安装包和持续集成相关的文件，通常可能包含三个目录</p>
<ul>
<li>/build/package: 存放容器（Docker）、系统(deb,rpm)的包配置和脚本</li>
<li>/build/ci: 存放CI（travis，circle）的配置文件</li>
<li>/build/docker: 存放子项目各个组件的Dockerfile文件</li>
</ul>
<h3 id="14-tools">14. /tools</h3>
<p>存放这个项目的支持工具，这些工具可导入来自/pkg和/internal目录的代码</p>
<h3 id="15-githooks">15. /githooks</h3>
<p>git钩子</p>
<h3 id="16-assets">16. /assets</h3>
<p>项目使用的其他资源（图片、CSS、Javascript等）</p>
<h3 id="17-website">17. /website</h3>
<p>放置项目网站相关的数据</p>
<h3 id="18-readmemd">18. /README.md</h3>
<p>一般包含项目介绍、功能介绍、快速按照、使用指引、详细文档连接和开发指引等
文件较长时可以用<a href="https://github.com/nochso/tocenize">tocenize</a>加目录</p>
<h3 id="19-docs">19. /docs</h3>
<p>存放设计文档、开放文档和用户文档等，可能包含下面几个目录</p>
<p>/docs/devel/{en-US, zh-CN}: 存放开发文档
/docs/guide/{en-US, zh-CN}: 存放用户手册
/docs/images: 存放图片文件</p>
<h3 id="20-contributingmd">20. /CONTRIBUTING.md</h3>
<p>用来说明如何贡献代码，规范协同流程</p>
<h3 id="21-api">21. /api</h3>
<p>存放项目提供的各种不同类型的API接口定义文件，可能有openapi、swagger等目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">├── openapi/
│   └── README.md
└── swagger/
    ├── docs/
    ├── README.md
    └── swagger.yaml
</code></pre></td></tr></table>
</div>
</div><h3 id="22-license">22. /LICENSE</h3>
<p>版权文件</p>
<p>如果需要给源码文件加license头时，可以使用<a href="https://github.com/marmotedu/addlicense">addlicense</a></p>
<p>项目依赖第三方包使用的license检查使用<a href="https://github.com/ribice/glice">glice</a></p>
<h3 id="23-changelog">23. /CHANGELOG</h3>
<p>项目更新日志，可结合Angular规范和git-chglog自动生成内容</p>
<h3 id="24-examples">24. /examples</h3>
<p>存放代码示例</p>
<h2 id="其他建议">其他建议</h2>
<ul>
<li>不使用/model目录，按功能拆分到使用的模块中</li>
<li>目录和包尽量使用单数</li>
<li>小项目可以先包含cmd、pkg、internal三个目录</li>
</ul>
<h1 id="第六讲-工作流设计">第六讲 工作流设计</h1>
<h2 id="功能分支工作流">功能分支工作流</h2>
<p>开发新功能时，基于master分支新建一个功能分支，在功能分支上进行开发，开发完之后合并到master</p>
<p>该模式适合小规模、人员固定的项目</p>
<h2 id="git-flow工作流">Git Flow工作流</h2>
<p>Git Flow定义了5种分支： master、develop、release、 feature、hotfix，详细介绍如下</p>
<p><img src="/image/go_develop_in_action/7_1.webp" alt="git-flow"></p>
<p>假设当前在一个future分支开发，突然发现了线上bug，需要hotfix，则流程如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ git stash <span class="c1"># 1. 开发工作只完成了一半，还不想提交，可以临时保存修改至堆栈区</span>
$ git checkout -b hotfix/print-error master <span class="c1"># 2. 从 master 建立 hotfix 分支</span>
$ vi main.go <span class="c1"># 3. 修复 bug，callmainfunction -&gt; call main function</span>
$ git commit -a -m <span class="s1">&#39;fix print message error bug&#39;</span> <span class="c1"># 4. 提交修复</span>
$ git checkout develop <span class="c1"># 5. 切换到 develop 分支</span>
$ git merge --no-ff hotfix/print-error <span class="c1"># 6. 把 hotfix 分支合并到 develop 分支</span>
$ git checkout master <span class="c1"># 7. 切换到 master 分支</span>
$ git merge --no-ff hotfix/print-error <span class="c1"># 8. 把 hotfix 分支合并到 master</span>
$ git tag -a v0.9.1 -m <span class="s2">&#34;fix log bug&#34;</span> <span class="c1"># 9. master 分支打 tag</span>
$ go build -v . <span class="c1"># 10. 编译代码，并将编译好的二进制更新到生产环境</span>
$ git branch -d hotfix/print-error <span class="c1"># 11. 修复好后，删除 hotfix/xxx 分支</span>
$ git checkout feature/print-hello-world <span class="c1"># 12. 切换到开发分支下</span>
$ git merge --no-ff develop <span class="c1"># 13. 因为 develop 有更新，这里最好同步更新下</span>
$ git stash pop <span class="c1"># 14. 恢复到修复前的工作状态</span>
</code></pre></td></tr></table>
</div>
</div><p>该模式适合人员固定、规模较大的项目</p>
<h2 id="forking工作流">Forking工作流</h2>
<p>开源项目常用模式</p>
<p><img src="/image/go_develop_in_action/7_2.webp" alt="git-forking"></p>
<h1 id="第七讲-研发流程设计">第七讲 研发流程设计</h1>
<h2 id="研发流程">研发流程</h2>
<p>通常研发流程包括6个阶段</p>
<ol>
<li>需求阶段</li>
<li>设计阶段</li>
<li>开发阶段</li>
<li>测试阶段</li>
<li>发布阶段</li>
<li>运营阶段</li>
</ol>
<p><img src="/image/go_develop_in_action/8_1.png" alt="git-forking"></p>
<p>每个阶段结束时，需要一个最终产物，可以是文档、代码或者部署组件，这个产物是下一个阶段的输入</p>
<h2 id="研发模式">研发模式</h2>
<p>研发模式有三种： 瀑布模式、迭代模式和敏捷模式</p>
<h3 id="瀑布模式">瀑布模式</h3>
<p>瀑布墨迹按照预先规划好的阶段来推进研发进度，流程清晰,但研发周期长，交付后变更困难
<img src="/image/go_develop_in_action/8_2.webp" alt="git-forking"></p>
<h3 id="迭代模式">迭代模式</h3>
<p>研发任务被切分为一系列轮次，先把主要功能搭建起来，在通过客户反馈不断完善</p>
<h3 id="敏捷模式">敏捷模式</h3>
<p>敏捷模式把大需求分成多个、可分阶段完成的小迭代，每个迭代交付都是一个可用的软件，开发过程中，软件一直处于可用状态</p>
<p>迭代模式关注研发流程。而敏捷模式不仅会关注研发流程，还会关注之外的一些东西，例如：团队协作，需求拆分</p>
<h2 id="cicd">CI/CD</h2>
<p>CI/CD通过自动化的手段来快速执行代码检查、测试、构建和部署任务，从而提高研发效率</p>
<ul>
<li>CI：Continuous Integration，持续集成</li>
<li>CD：Continuous Delivery，持续交付</li>
<li>CD：Continuous Deployment，持续部署</li>
</ul>
<p><img src="/image/go_develop_in_action/8_3.webp" alt="git-forking"></p>
<p>持续集成的核心在代码，持续交付的核心在可交付的产物，持续部署的核心在自动部署</p>
<h3 id="持续集成">持续集成</h3>
<p>在代码push到git仓库后，CI工具会进行扫描、测试和构建，并将结果反馈给开发者</p>
<p>CI流程可以将问题在开发阶段就暴露出来，这会让开发人员交付代码时更有信心</p>
<h3 id="持续交付">持续交付</h3>
<p>在持续集成的基础上，就构建产物自动部署到目标环境（测试、预发布）</p>
<h3 id="持续部署">持续部署</h3>
<p>在持续交付的基础上，将经过充分测试的代码自动部署到生产环境，整个流程不在需要审核，完全自动化</p>
<h2 id="devops">DevOps</h2>
<p>DevOps是一组过程、方法和系统的统称，用于促进开发、运维、质量部门之间的协作整合
<img src="/image/go_develop_in_action/8_4.webp" alt="git-forking"></p>
<p>目前常用的Ops手段： AIOps、ChatOps、GitOps</p>
<h3 id="chatops">ChatOps</h3>
<p>通过发送指令给聊天机器人，执行某个任务
ChatOps对操作者友好，信息透明可追溯</p>
<h3 id="gitops">GitOps</h3>
<p>基于Git和K8S实现云原生的持续交付</p>
<h3 id="aiops">AIOps</h3>
<p>利用AI技术来智能化运维IT系统</p>
<h1 id="第八讲-设计方法">第八讲 设计方法</h1>
<p><img src="/image/go_develop_in_action/10_1.webp" alt="go-application"></p>
<h2 id="代码结构">代码结构</h2>
<p>按功能拆分目录而非按MVC等模块拆封</p>
<h2 id="代码规范">代码规范</h2>
<p>可参考Uber的规范：<a href="https://github.com/uber-go/guide/blob/master/style.md">Go Style Guide</a></p>
<p>可使用惊呆检查工具：<a href="https://github.com/golangci/golangci-lint">golangcli-lint</a></p>
<p>官方CodeReview实践：<a href="https://github.com/golang/go/wiki/CodeReviewComments">Go Code Review Comments</a></p>
<h2 id="代码质量">代码质量</h2>
<p>测试相关工具：</p>
<ul>
<li>官方Mock框架： <a href="https://github.com/golang/mock">golang/mock</a></li>
<li>数据库Mock： <a href="https://github.com/DATA-DOG/go-sqlmock">golang/mock</a></li>
<li>HTTP Mock： <a href="https://github.com/jarcoal/httpmock">golang/mock</a></li>
<li>万能Mock： <a href="https://github.com/bouk/monkey">golang/mock</a></li>
</ul>
<p>覆盖率检查</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ go <span class="nb">test</span> -race -cover  -coverprofile<span class="o">=</span>./coverage.out -timeout<span class="o">=</span>10m -short -v ./...
$ go tool cover -func ./coverage.out
</code></pre></td></tr></table>
</div>
</div><h2 id="编程哲学">编程哲学</h2>
<ul>
<li>面向接口编程</li>
<li>面向对象编程</li>
</ul>
<h2 id="软件设计方法">软件设计方法</h2>
<ul>
<li>设计模式</li>
<li>SOLD原则</li>
</ul>
<h2 id="高效项目管理">高效项目管理</h2>
<ul>
<li>
<p>使用Makefile管理项目</p>
</li>
<li>
<p>自动生成代码
<img src="/image/go_develop_in_action/10_2.webp" alt="automate-code"></p>
</li>
<li>
<p>对接CI、CD</p>
</li>
<li>
<p>编写高质量的文档</p>
</li>
</ul>
<h1 id="第九讲-设计模式">第九讲 设计模式</h1>
<p><img src="/image/go_develop_in_action/11_1.webp" alt="design-pattern"></p>
<h2 id="创建型模式">创建型模式</h2>
<p>创建型模式（Creational Patterns）提供了在创建对象的同事隐藏创建逻辑的方式，而不是使用new运算符直接实例化对象。</p>
<p>比较常见的是单例模式和工厂模式</p>
<h3 id="单例模式">单例模式</h3>
<p>单例模式（Singleton Pattern）指全局只有一个实例，有利于减少内存开销，防止冲突等优点，常用于数据库实例、全局配置等</p>
<ul>
<li>饿汉模式：初始化时创建</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">singleton</span>

<span class="kd">type</span> <span class="nx">singleton</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">ins</span> <span class="o">*</span><span class="nx">singleton</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">singleton</span><span class="p">{}</span>

<span class="kd">func</span> <span class="nf">GetInsOr</span><span class="p">()</span> <span class="o">*</span><span class="nx">singleton</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ins</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>懒汉模式：实际使用时创建，可能有并发问题，需要加锁</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">singleton</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;sync&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">singleton</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">ins</span> <span class="o">*</span><span class="nx">singleton</span>
<span class="kd">var</span> <span class="nx">once</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>

<span class="kd">func</span> <span class="nf">GetInsOr</span><span class="p">()</span> <span class="o">*</span><span class="nx">singleton</span> <span class="p">{</span>
  <span class="nx">once</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">ins</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">singleton</span><span class="p">{}</span>
  <span class="p">})</span>
  <span class="k">return</span> <span class="nx">ins</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="工厂模式">工厂模式</h3>
<ul>
<li>简单工厂模式：接受参数，返回一个对象实例</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span> <span class="kt">string</span>
  <span class="nx">Age</span>  <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="nx">Person</span><span class="p">)</span> <span class="nf">Greet</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Hi, my name is %s\n&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewPerson</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">age</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">Person</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Person</span><span class="p">{</span>
  <span class="nx">Name</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span>
  <span class="nx">Age</span><span class="p">:</span>  <span class="nx">age</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>抽象工厂模式: 返回接口而非结构体</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kd">type</span> <span class="nx">Doer</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Do</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewHTTPClient</span><span class="p">()</span> <span class="nx">Doer</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">mockHTTPClient</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">mockHTTPClient</span><span class="p">)</span> <span class="nf">Do</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span> <span class="o">:=</span> <span class="nx">httptest</span><span class="p">.</span><span class="nf">NewRecorder</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">Result</span><span class="p">(),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewMockHTTPClient</span><span class="p">()</span> <span class="nx">Doer</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">mockHTTPClient</span><span class="p">{}</span>
<span class="p">}</span>  
</code></pre></td></tr></table>
</div>
</div><ul>
<li>工厂方法模式: 通过实现工厂接口来创建多种工厂</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="kt">string</span>
  <span class="nx">age</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewPersonFactory</span><span class="p">(</span><span class="nx">age</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Person</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Person</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Person</span><span class="p">{</span>
      <span class="nx">name</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span>
      <span class="nx">age</span><span class="p">:</span> <span class="nx">age</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="nx">newBaby</span> <span class="o">:=</span> <span class="nf">NewPersonFactory</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">baby</span> <span class="o">:=</span> <span class="nf">newBaby</span><span class="p">(</span><span class="s">&#34;john&#34;</span><span class="p">)</span>

<span class="nx">newTeenager</span> <span class="o">:=</span> <span class="nf">NewPersonFactory</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="nx">teen</span> <span class="o">:=</span> <span class="nf">newTeenager</span><span class="p">(</span><span class="s">&#34;jill&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="结构型模式">结构型模式</h2>
<p>结构型模式的特点是关注类和对象的组合</p>
<h3 id="策略模式">策略模式</h3>
<p>定义策略接口，并实现不同的策略，策略执行者可以设置不同的策略</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">IStrategy</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">do</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">add</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">add</span><span class="p">)</span> <span class="nf">do</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">reduce</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">reduce</span><span class="p">)</span> <span class="nf">do</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">a</span> <span class="o">-</span> <span class="nx">b</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Operator</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">strategy</span> <span class="nx">IStrategy</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">Operator</span><span class="p">)</span> <span class="nf">setStrategy</span><span class="p">(</span><span class="nx">strategy</span> <span class="nx">IStrategy</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">o</span><span class="p">.</span><span class="nx">strategy</span> <span class="p">=</span> <span class="nx">strategy</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">Operator</span><span class="p">)</span> <span class="nf">calculate</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">strategy</span><span class="p">.</span><span class="nf">do</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="模板模式">模板模式</h3>
<p>将一个类中能公共使用的方法放置在抽象类中实现，将不能公共使用的方法作为抽象方法强制子类去实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kn">package</span> <span class="nx">template</span>

<span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>

<span class="kd">type</span> <span class="nx">Cooker</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="nf">fire</span><span class="p">()</span>
  <span class="nf">cooke</span><span class="p">()</span>
  <span class="nf">outfire</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// 类似于一个抽象类
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">CookMenu</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">CookMenu</span><span class="p">)</span> <span class="nf">fire</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;开火&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 做菜，交给具体的子类实现
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">CookMenu</span><span class="p">)</span> <span class="nf">cooke</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">CookMenu</span><span class="p">)</span> <span class="nf">outfire</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;关火&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 封装具体步骤
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">doCook</span><span class="p">(</span><span class="nx">cook</span> <span class="nx">Cooker</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">cook</span><span class="p">.</span><span class="nf">fire</span><span class="p">()</span>
  <span class="nx">cook</span><span class="p">.</span><span class="nf">cooke</span><span class="p">()</span>
  <span class="nx">cook</span><span class="p">.</span><span class="nf">outfire</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">XiHongShi</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">CookMenu</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">XiHongShi</span><span class="p">)</span> <span class="nf">cooke</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;做西红柿&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">ChaoJiDan</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">CookMenu</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ChaoJiDan</span><span class="p">)</span> <span class="nf">cooke</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;做炒鸡蛋&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="行为型模式">行为型模式</h2>
<p>行为模式的特点是关注对象之间的通信</p>
<h3 id="代理模式">代理模式</h3>
<p>代理模式Proxy pattern 可以为另外一个对象提供一个替身或者占位符，以控制对这个对象的访问</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kn">package</span> <span class="nx">proxy</span>

<span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>

<span class="kd">type</span> <span class="nx">Seller</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="nf">sell</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 火车站
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Station</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">stock</span> <span class="kt">int</span> <span class="c1">//库存
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">station</span> <span class="o">*</span><span class="nx">Station</span><span class="p">)</span> <span class="nf">sell</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">station</span><span class="p">.</span><span class="nx">stock</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">station</span><span class="p">.</span><span class="nx">stock</span><span class="o">--</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;代理点中：%s买了一张票,剩余：%d \n&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">station</span><span class="p">.</span><span class="nx">stock</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;票已售空&#34;</span><span class="p">)</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// 火车代理点
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">StationProxy</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">station</span> <span class="o">*</span><span class="nx">Station</span> <span class="c1">// 持有一个火车站对象
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">proxy</span> <span class="o">*</span><span class="nx">StationProxy</span><span class="p">)</span> <span class="nf">sell</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">station</span><span class="p">.</span><span class="nx">stock</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">proxy</span><span class="p">.</span><span class="nx">station</span><span class="p">.</span><span class="nx">stock</span><span class="o">--</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;代理点中：%s买了一张票,剩余：%d \n&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">station</span><span class="p">.</span><span class="nx">stock</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;票已售空&#34;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="选项模式">选项模式</h3>
<p>通过选项模式可以创建一个带有默认值得struct变量，并选择性的修改其中一些参数的值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">options</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Connection</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">addr</span>    <span class="kt">string</span>
  <span class="nx">cache</span>   <span class="kt">bool</span>
  <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="p">(</span>
  <span class="nx">defaultTimeout</span> <span class="p">=</span> <span class="mi">10</span>
  <span class="nx">defaultCaching</span> <span class="p">=</span> <span class="kc">false</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">options</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
  <span class="nx">caching</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="c1">// Option overrides behavior of Connect.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Option</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="nf">apply</span><span class="p">(</span><span class="o">*</span><span class="nx">options</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">optionFunc</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">options</span><span class="p">)</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">optionFunc</span><span class="p">)</span> <span class="nf">apply</span><span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">f</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">t</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nf">optionFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">timeout</span> <span class="p">=</span> <span class="nx">t</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">WithCaching</span><span class="p">(</span><span class="nx">cache</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nf">optionFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">caching</span> <span class="p">=</span> <span class="nx">cache</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1">// Connect creates a connection.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewConnect</span><span class="p">(</span><span class="nx">addr</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Option</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Connection</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">{</span>
    <span class="nx">timeout</span><span class="p">:</span> <span class="nx">defaultTimeout</span><span class="p">,</span>
    <span class="nx">caching</span><span class="p">:</span> <span class="nx">defaultCaching</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
    <span class="nx">o</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Connection</span><span class="p">{</span>
    <span class="nx">addr</span><span class="p">:</span>    <span class="nx">addr</span><span class="p">,</span>
    <span class="nx">cache</span><span class="p">:</span>   <span class="nx">options</span><span class="p">.</span><span class="nx">caching</span><span class="p">,</span>
    <span class="nx">timeout</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">timeout</span><span class="p">,</span>
  <span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="第十讲-api风格">第十讲 API风格</h1>
<h2 id="restful-api设计原则">Restful API设计原则</h2>
<h3 id="uri设计">URI设计</h3>
<p>通常情况下：</p>
<ul>
<li>资源使用名词复数表示</li>
<li>URI结尾不包含<code>/</code></li>
<li>推荐使用<code>-</code></li>
<li>使用小写</li>
<li>避免层级过深，超过2层时将其他资源转为？参数，比如</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">/schools/tsinghua/classes/rooma/students/zhang <span class="c1"># 不推荐</span>
/students?school<span class="o">=</span>qinghua<span class="p">&amp;</span><span class="nv">class</span><span class="o">=</span>rooma <span class="c1"># 推荐</span>
</code></pre></td></tr></table>
</div>
</div><p>实际场景中某些操作不能很好地映射为资源，可以参考如下做法：</p>
<ul>
<li>将一个操作变成一个资源的属性，比如禁用用户可以设计URI: /users/zhangsan?active=false</li>
<li>将操作当做是一个资源的嵌套资源，如github star:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">PUT /gits/:id/star
DELETE /gits/:id/star
</code></pre></td></tr></table>
</div>
</div><ul>
<li>有时也可以打破规范，如登录操作URI设计为：/login</li>
</ul>
<h3 id="操作和方法之间的映射">操作和方法之间的映射</h3>
<p><img src="/image/go_develop_in_action/12_1.webp" alt="resource-operation"></p>
<p>对资源的操作应蛮子安全性和幂等性：</p>
<ul>
<li>安全性：不会改变资源状态，可以理解为只读</li>
<li>幂等性：执行1次和执行N次，对资源状态改变的效果是等价的</li>
</ul>
<p><img src="/image/go_develop_in_action/12_2.webp" alt="idempotence"></p>
<p>POST一般用在新建和批量删除这两种场景，批量删除更建议使用：DELETE /users?id=1,2,3</p>
<h3 id="统一分页过滤排序搜索功能">统一分页/过滤/排序/搜索功能</h3>
<ul>
<li>分页：在列出一个Collection所有Member时应该提供分页功能，如：/users?offset=0&amp;limit=20</li>
<li>过滤：当不用返回一个资源的全部属性时可以指定，如：/users?fields=email,username,address</li>
<li>排序：根据指定字段排序，如：/users?sort=age,desc</li>
<li>搜索：当一个资源的Member太多时，可能需要提供搜索功能，搜索建议按模糊搜索来匹配</li>
</ul>
<h3 id="域名">域名</h3>
<p>主要有两种方式：</p>
<ul>
<li><a href="https://abc.com/api">https://abc.com/api</a> 适用该域名只有一套API系统的情况</li>
<li><a href="https://project.api.abc.com">https://project.api.abc.com</a> 适用域名下有多个系统API</li>
</ul>
<h2 id="rpc-api">RPC API</h2>
<p>RPC（Remote Procedure Call）即远程过程调用，通俗地来讲就是服务端实现了一个函数，
客户端使用RPC框架提供的接口，想调用本地函数一样调用这个函数，并获取返回值。</p>
<p>protobuf3可以使用<code>optional</code>关键字来支持显示判断是否传入该字段</p>
<ul>
<li>golang会将该字段转为指针类型，可以判断是否为<code>nil</code></li>
<li>python可以通过<code>HasField</code>方法来判断</li>
</ul>
<p>可以通过grpc-gateway来同时支持restful-api</p>
<p><img src="/image/go_develop_in_action/13_1.webp" alt="rpc-vs-rest"></p>
<h1 id="第十一讲-makefile">第十一讲 Makefile</h1>
<h2 id="基本形式">基本形式</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">&lt;target&gt; </span><span class="o">:</span> &lt;<span class="n">prerequisites</span>&gt; 
<span class="err">[tab]</span>  <span class="err">&lt;commands&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>target: 目标，目标非文件时称之为伪目标PHONBY</li>
<li>prerequisities： 前置依赖目标</li>
<li>command: 具体的shell命令，以<code>tab</code>起手，每一行都是单独的session, 可用<code>；</code>共用session，使用<code>\</code>作为换行符</li>
</ul>
<h2 id="基本语法">基本语法</h2>
<h3 id="声明伪目标">声明伪目标</h3>
<p>避免有和target同名的文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">clean</span>
<span class="nf">clean</span><span class="o">:</span>
    rm -rf *.c
</code></pre></td></tr></table>
</div>
</div><h3 id="关闭回声">关闭回声</h3>
<p>命令前面加<code>@</code>不会先打印命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">test</span><span class="o">:</span>
    @echo <span class="s1">&#39;hello world&#39;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="忽略错误">忽略错误</h3>
<p>命令前面加<code>-</code>可忽略错误，继续往下执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">test</span><span class="o">:</span>
	-eco <span class="s1">&#39;hello world&#39;</span>
	@echo <span class="s1">&#39;hello world2&#39;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="通配符">通配符</h3>
<p>支持<code>%</code>、<code>*</code>、<code>~</code></p>
<h2 id="变量和赋值">变量和赋值</h2>
<ul>
<li>使用<code>=</code>自动以变量</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nv">msg</span> <span class="o">=</span> <span class="s1">&#39;Hello world&#39;</span> 
</code></pre></td></tr></table>
</div>
</div><ul>
<li>四种赋值运算符</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nv">VARIABLE</span> <span class="o">=</span> value
<span class="c"># 在执行时扩展，允许递归扩展。
</span><span class="c"></span>
<span class="nv">VARIABLE</span> <span class="o">:=</span> value
<span class="c"># 在定义时扩展。
</span><span class="c"></span>
<span class="nv">VARIABLE</span> <span class="o">?=</span> value
<span class="c"># 只有在该变量为空时才设置值。
</span><span class="c"></span>
<span class="nv">VARIABLE</span> <span class="o">+=</span> value
<span class="c"># 将值追加到变量的尾端。
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>使用<code>$()</code>引用变量</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nv">msg</span> <span class="o">=</span> <span class="s1">&#39;hello world&#39;</span>
<span class="nf">test</span><span class="o">:</span>
    <span class="nb">echo</span> <span class="k">$(</span>msg<span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>调用系统变量是需在再加一个<code>$</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">test</span><span class="o">:</span>
    echo: <span class="nv">$$</span>HOME
</code></pre></td></tr></table>
</div>
</div><h3 id="自动变量">自动变量</h3>
<ul>
<li><code>$@</code>: 指当前目标</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">a.txt</span><span class="o">:</span>
    <span class="nb">echo</span> <span class="s1">&#39;hello&#39;</span> &gt; <span class="nv">$@</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>$&lt;</code>: 指第一个前置条件</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">a.txt</span><span class="o">:</span> <span class="n">b</span>.<span class="n">txt</span> <span class="n">c</span>.<span class="n">txt</span>
    cp $&lt; <span class="nv">$@</span> 
<span class="c"># 等同于  
</span><span class="c"></span><span class="nf">a.txt</span><span class="o">:</span> <span class="n">b</span>.<span class="n">txt</span> <span class="n">c</span>.<span class="n">txt</span>
    cp b.txt a.txt 
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>$^</code>: 指所有前置条件</li>
<li><code>$*</code>: 指被<code>%</code>匹配的部分</li>
<li><code>$(@D)</code>：指向<code>$@</code>的目录名</li>
<li><code>$(@F)</code>：指向<code>$@</code>的文件名</li>
</ul>
<h2 id="条件语句">条件语句</h2>
<ul>
<li><code>ifeq</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="err">ifeq</span> <span class="err">(arg1,</span> <span class="err">arg)</span>
    <span class="err">echo</span> <span class="s1">&#39;eq&#39;</span>
<span class="err">else</span>
    <span class="err">echo</span> <span class="s1">&#39;neq&#39;</span>
<span class="err">endif</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>ifdef</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="err">ifdef</span> <span class="err">var1</span>
    <span class="err">echo</span> <span class="s1">&#39;var1 exist&#39;</span>
<span class="err">endif</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="循环语句">循环语句</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nv">LIST</span> <span class="o">=</span> one two three
<span class="err">for</span> <span class="err">i</span> <span class="err">in</span> <span class="k">$(</span><span class="nv">LIST</span><span class="k">)</span><span class="err">;</span> <span class="err">do</span>
    <span class="err">echo</span> <span class="k">$$</span><span class="err">i;</span>
<span class="err">done;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="内置函数">内置函数</h2>
<ul>
<li>shell: 执行shell命令</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nv">files</span> <span class="o">:=</span> <span class="k">$(</span>shell <span class="nb">echo</span> *.c<span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>substr: 字符串替换</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="c"># 将ee换成大写
</span><span class="c"></span><span class="k">$(</span><span class="nv">subst</span> <span class="nv">ee</span>,<span class="nv">EE</span>,<span class="nv">feet</span> <span class="nv">on</span> <span class="nv">the</span> <span class="nv">street</span><span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>patsubstr: 字符串模式匹配替换</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="k">$(</span><span class="nv">patsubst</span> %.<span class="nv">c</span>,%.<span class="nv">o</span>,<span class="nv">x</span>.<span class="nv">c</span> <span class="nv">bar</span>.<span class="nv">c</span><span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="第十二讲-流程管理">第十二讲 流程管理</h1>
<ul>
<li>使用git-flow工作流</li>
<li>使用Makefile同一规范</li>
</ul>
<h2 id="静态代码检查">静态代码检查</h2>
<p>使用强大的<code>golangci-lint</code></p>
<h2 id="swagger文档生成">swagger文档生成</h2>
<p>使用<code>go-swagger</code>自动生成openapi规范的文档</p>
<h1 id="第十三讲-错误处理">第十三讲 错误处理</h1>
<h2 id="https-code">HTTPS CODE</h2>
<p>建议使用主要的几个错误码:</p>
<ul>
<li>200： 请求成功</li>
<li>400： 客户端问题</li>
<li>500： 服务端问题</li>
</ul>
<p>需要的的话额外补充:</p>
<ul>
<li>401： 认证失败</li>
<li>403： 授权失败</li>
<li>404： 资源不存在</li>
<li>429： 请求超频</li>
</ul>
<h2 id="错误码设计">错误码设计</h2>
<p>使用六位整数，分为三部分， 前两位表示服务，中间两位表示具体模块，末两位表示错误码序号</p>
<h2 id="错误包设计">错误包设计</h2>
<h2 id="需求">需求</h2>
<ul>
<li>支持记录错误堆栈</li>
<li>支持打印不同格式的信息
<ul>
<li><code>s</code>: 打印展示给用户的信息（Code.String()）</li>
<li><code>v</code>: 同上</li>
<li><code>-v</code>: 打印最顶层的错误码、调用栈、用户展示信息、内部信息</li>
<li><code>+v</code>: 递归打印<code>-v</code>上述信息</li>
<li><code>#+v</code>: 同<code>+v</code>, 但以JSON格式输出，方便日志收集</li>
</ul>
</li>
<li>支持Wrap/Unwrap功能</li>
<li>支持Is判断功能</li>
<li>支持As转换功能</li>
<li>支持格式化和非格式化创建
<ul>
<li>errors.New</li>
<li>errors.Errorf</li>
</ul>
</li>
</ul>
<h2 id="实现">实现</h2>
<p>基于<code>githu.com/pkg/errors</code>二次开发</p>
<h3 id="增加withcode结构体">增加WithCode结构体</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kd">type</span> <span class="nx">withCode</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">err</span> <span class="kt">error</span>
    <span class="nx">code</span> <span class="kt">int</span>
    <span class="nx">cause</span> <span class="kt">error</span>
    
    <span class="o">*</span><span class="nx">stack</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="错误码实现">错误码实现</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//Code接口
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Coder</span> <span class="kd">interface</span> <span class="p">{</span>
<span class="c1">// HTTP status that should be used for the associated error code.
</span><span class="c1"></span><span class="nf">HTTPStatus</span><span class="p">()</span> <span class="kt">int</span>

<span class="c1">// External (user) facing error text.
</span><span class="c1"></span><span class="nf">String</span><span class="p">()</span> <span class="kt">string</span>

<span class="c1">// Reference returns the detail documents for user.
</span><span class="c1"></span><span class="nf">Reference</span><span class="p">()</span> <span class="kt">string</span>

<span class="c1">// Code returns the code of the coder
</span><span class="c1"></span><span class="nf">Code</span><span class="p">()</span> <span class="kt">int</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="第十四讲-日志包设计">第十四讲 日志包设计</h1>
<h2 id="基础功能">基础功能</h2>
<ol>
<li>支持基本的日志信息：时间戳、文件名、行号、日志级别和日志信息</li>
<li>支持不同的日志级别</li>
<li>支持自定义配置，如调整日志级别，调整输出格式等</li>
<li>支持输出到标准输出和文件</li>
</ol>
<h2 id="高级功能">高级功能</h2>
<ol>
<li>支持多种日志格式，如支持JSON格式方便filebeat日志采集工具采集并上报</li>
<li>能够按级别分类输出</li>
<li>支持日志轮转</li>
<li>具备HOOK能力，如发邮件高级等</li>
</ol>
<h2 id="可选功能">可选功能</h2>
<ol>
<li>支持颜色输出</li>
<li>兼容标准log包</li>
<li>支持输出到不同的位置如Kafka等组件</li>
</ol>
<h2 id="关注点">关注点</h2>
<ul>
<li>高性能</li>
<li>并发安全</li>
<li>插件化能力</li>
<li>参数控制</li>
</ul>
<h2 id="分布式日志解决方法efk">分布式日志解决方法（EFK）</h2>
<p><img src="/image/go_develop_in_action/20_1.webp" alt="EFK"></p>
<ol>
<li>Logstash Shipper监控采集日志，并发送到Kafka</li>
<li>Logstash Indexer消费Kafka中的日志，处理后投递到Elasticsearch中</li>
<li>Elasticsearch提供搜集、分析和存储数据三大功能</li>
<li>Kibaba提供Web界面</li>
</ol>
<h1 id="第十五讲-日志包实现">第十五讲 日志包实现</h1>
<h2 id="优先开源日志包">优先开源日志包</h2>
<ul>
<li>标准log包</li>
<li>glog: 实现了基本功能适合小项目</li>
<li>logrus: 功能强大，适合大型项目</li>
<li>zap: 性能高，内存分配次数少，适合对日志性能要求很高的项目</li>
</ul>
<h1 id="第十六讲-web服务核心功能">第十六讲 Web服务核心功能</h1>
<p><img src="/image/go_develop_in_action/23_1.webp" alt="core-function"></p>
<h1 id="第十七讲-认证机制">第十七讲 认证机制</h1>
<h2 id="认证和授权的区别">认证和授权的区别</h2>
<ul>
<li>认证（Authentication）: 用来验证某个用户是否具有访问系统的权限</li>
<li>授权（Authorization）: 用来验证某个  用户是否具有访问某个资源的权限</li>
</ul>
<h2 id="四种基本的认证方式">四种基本的认证方式</h2>
<h3 id="basic">Basic</h3>
<p>将<code>用户名:密码</code>进行base64编码后放到HTTP Authorization HEADER中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="nv">basic</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -n <span class="s1">&#39;username:password&#39;</span> <span class="p">|</span> base64<span class="sb">`</span>
curl -X POST -H <span class="s2">&#34;Authorization: Basic </span><span class="si">${</span><span class="nv">basic</span><span class="si">}</span><span class="s2">&#34;</span> http://localhost:8080/login
</code></pre></td></tr></table>
</div>
</div><p>这个方式使用了base64编码，入侵者可以反向编码获取用户名和密码；另外即使密码被加密，入侵者可以进行重放攻击</p>
<p>所以Basic虽简单，但既不安全，需要和SSL配合使用</p>
<h3 id="digest">Digest</h3>
<p><img src="/image/go_develop_in_action/25_1.webp" alt="digest">
服务端给随机数nonce和加密算法（默认为md5）,客户端请求是需要提供
密码叉腰response</p>
<h3 id="oauth">OAuth</h3>
<p>OAuth(开放授权)允许用户让第三方应用访问该用户在某一个服务的思路资源（如昵称、头像等），
而无需将用户名和密码给第三方应用</p>
<p>OAuth2.0共分为四种授权方式</p>
<h4 id="密码式">密码式</h4>
<p>认证流程如下：</p>
<ol>
<li>网站 A 向用户发出获取用户名和密码的请求；</li>
<li>用户同意后，网站 A 凭借用户名和密码向网站 B 换取令牌；</li>
<li>网站 B 验证用户身份后，给出网站 A 令牌，网站 A 凭借令牌可以访问网站 B 对应权限的资源。</li>
</ol>
<h4 id="隐藏式">隐藏式</h4>
<p>这种方式适用于前端应用。认证流程如下：</p>
<ol>
<li>A 网站提供一个跳转到 B 网站的链接，用户点击后跳转至 B 网站，并向用户请求授权；</li>
<li>用户登录 B 网站，同意授权后，跳转回 A 网站指定的重定向 redirect_url 地址，并携带 B 网站返回的令牌，用户在 B 网站的数据给 A 网站使用。</li>
</ol>
<p>这个授权方式存在着“中间人攻击”的风险，因此只能用于一些安全性要求不高的场景，并且令牌的有效时间要非常短。</p>
<h4 id="凭借式">凭借式</h4>
<p>这种方式是在命令行中请求授权，适用于没有前端的命令行应用。认证流程如下：</p>
<ol>
<li>应用 A 在命令行向应用 B 请求授权，此时应用 A 需要携带应用 B 提前颁发的 secretID 和 secretKey，其中 secretKey 出于安全性考虑，需在后端发送；</li>
<li>应用 B 接收到 secretID 和 secretKey，并进行身份验证，验证通过后返回给应用 A 令牌。</li>
</ol>
<h4 id="授权码式">授权码式</h4>
<ol>
<li>A 网站提供一个跳转到 B 网站的链接 +redirect_url，用户点击后跳转至 B 网站；</li>
<li>用户携带向 B 网站提前申请的 client_id，向 B 网站发起身份验证请求；</li>
<li>用户登录 B 网站，通过验证，授予 A 网站权限，此时网站跳转回 redirect_url，其中会有 B 网站通过验证后的授权码附在该 url 后；</li>
<li>网站 A 携带授权码向网站 B 请求令牌，网站 B 验证授权码后，返回令牌即 access_token。</li>
</ol>
<h3 id="bearer">Bearer</h3>
<p>Bearer认证也称令牌认证，核心是 bearer token。bearer token 是一个加密字符串，通常由服务端根据密钥生成。客户端在请求服务端时，必须在请求头中包含Authorization: Bearer 。服务端收到请求后，解析出 ，并校验 的合法性。
当前最流行的 token 编码方式是 JSON Web Token</p>
<p><img src="/image/go_develop_in_action/25_2.webp" alt="jwt_auth">
具体可以分为四步：</p>
<ol>
<li>客户端使用用户名和密码请求登录。</li>
<li>服务端收到请求后，会去验证用户名和密码。如果用户名和密码跟数据库记录不一致，则验证失败；如果一致则验证通过，服务端会签发一个 Token 返回给客户端。</li>
<li>客户端收到请求后会将 Token 缓存起来，比如放在浏览器 Cookie 中或者 LocalStorage 中，之后每次请求都会携带该 Token。</li>
<li>服务端收到请求后，会验证请求中的 Token，验证通过则进行业务逻辑处理，处理完后返回处理后的结果。</li>
</ol>
<h1 id="第十八讲-iam的认证功能设计">第十八讲 IAM的认证功能设计</h1>
<h2 id="整体思路">整体思路</h2>
<ul>
<li>Basic认证摔死在前端登录的场景</li>
<li>Bearer认证用在调用后端API服务的场景</li>
</ul>
<h2 id="具体设计">具体设计</h2>
<p><img src="/image/go_develop_in_action/26_1.webp" alt="iam_auth"></p>
<ul>
<li>密钥CURD存储在iam-apiserver中</li>
<li>iam-authz-server将密钥信息缓存在内存中，通过grpc api获取</li>
<li>iam-apiserver有更新时，会发布到iam-authz-server订阅的频道</li>
</ul>
<h2 id="具体实现">具体实现</h2>
<p>因为项目要根据需要选择不同的认证方式，所以使用设计模式中的策略模式来实现</p>
<ul>
<li>basic策略： 实现了Basic认证</li>
<li>jwt策略：实现了Bearer认证</li>
<li>auto策略：根据HTTP HEAD自动选择Basic或Bearer认证</li>
<li>cache策略：从缓存中加载认证信息</li>
</ul>
<p><img src="/image/go_develop_in_action/26_2.webp" alt="iam_auth2"></p>
<h1 id="第十九讲-权限模型">第十九讲 权限模型</h1>
<p><img src="/image/go_develop_in_action/27_1.webp" alt="special_term"></p>
<h2 id="常见权限模型">常见权限模型</h2>
<h3 id="权限控制列表">权限控制列表</h3>
<p>ACL（Access Control List）用来判断用户是否可以对资源做特定的操作。例如允许Colin创建文章：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">Subject</span><span class="p">:</span><span class="w"> </span><span class="l">Colin</span><span class="w">
</span><span class="w"></span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="l">Create</span><span class="w">
</span><span class="w"></span><span class="nt">Object</span><span class="p">:</span><span class="w"> </span><span class="l">Article</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在ACL模型下，权限管理围绕资源Object来设定</p>
<h3 id="自主访问控制">自主访问控制</h3>
<p>DAC（Discretionary Access Control）是ACL的扩展模型，不仅可以判断Subject是否可以对Object执行Action，同时也能让Subject将
Object、Action的相同权限授予其他的Subject</p>
<h3 id="强制访问控制">强制访问控制</h3>
<p>MAC（Mandatory Access Control）是ACL的扩展模型，安全性更高，Subject和Object同时具有安全属性，只有
满足以下两点才能授权通过：</p>
<ol>
<li>Subject可以对Object做Action</li>
<li>Object可以被Subject做Action</li>
</ol>
<h3 id="基于角色的访问控制">基于角色的访问控制</h3>
<p>RBAC（Role-Based Access Control）引入了Role的概念，并将权限和角色进行关联，用户通过扮演某种角色，具有了该角色的所有权限</p>
<p><img src="/image/go_develop_in_action/27_2.webp" alt="RBAC"></p>
<p>RBAC又分为四种：</p>
<h4 id="rbac0">RBAC0</h4>
<p>基础模型，只包含核心的四要素（用户User、角色Role、权限Permission和会话Session）
用户和角色可以是多对多的关系，权限和角色也可以是多对多的关系</p>
<h4 id="rbac1">RBAC1</h4>
<p>包括RBAC0，并添加了角色继承</p>
<h4 id="rbac2">RBAC2</h4>
<p>包括RBAC0，并添加了约束，具有以下核心特性</p>
<ul>
<li>互斥约束：同一个用户不能有 互斥的角色，互斥的权限不能分配非同一个角色</li>
<li>基数约束：一个角色被分配的用户数量是受限的</li>
<li>先决条件角色：要想获得较高权限，首先要拥有低一级的权限</li>
<li>静态职责分离（Static Separation of Duty）：用户无法同时被赋予有冲突的角色</li>
<li>静态职责分离（Dynamic Separation of Duty）：会话中无法同时激活有冲突的角色</li>
</ul>
<h4 id="rbac3">RBAC3</h4>
<p>全功能的RBAC，合并了上面三种</p>
<h3 id="基于属性的权限验证">基于属性的权限验证</h3>
<p>ABAC（Attribute-Based Access Control）规定了哪些属性的用户对哪些属性的资源在哪些条件限制下进行哪些操作</p>
<p>相比RBAC, ABAC对权限的控制粒度更新，主要规定了下面的这四类属性：</p>
<ul>
<li>用户属性，如性别，年龄等</li>
<li>资源属性，如资源属性、类别等</li>
<li>操作属性，如创建、修改等</li>
<li>环境属性，如来源IP、当前时间等</li>
</ul>
<p>下面是腾讯云的的一个样例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json">
<span class="p">{</span>
  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;2.0&#34;</span><span class="p">,</span>
  <span class="nt">&#34;statement&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;effect&#34;</span><span class="p">:</span> <span class="s2">&#34;allow&#34;</span><span class="p">,</span>
      <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&#34;cos:List*&#34;</span><span class="p">,</span>
        <span class="s2">&#34;cos:Get*&#34;</span><span class="p">,</span>
        <span class="s2">&#34;cos:Head*&#34;</span><span class="p">,</span>
        <span class="s2">&#34;cos:OptionsObject&#34;</span>
      <span class="p">],</span>
      <span class="nt">&#34;resource&#34;</span><span class="p">:</span> <span class="s2">&#34;qcs::cos:ap-shanghai:uid/1250000000:Bucket1-1250000000/dir1/*&#34;</span><span class="p">,</span>
      <span class="nt">&#34;condition&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;ip_equal&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;qcs:ip&#34;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&#34;10.217.182.3/24&#34;</span><span class="p">,</span>
            <span class="s2">&#34;111.21.33.72/24&#34;</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面的授权策略表示：用户必须在 10.217.182.3/24 或者 111.21.33.72/24 网段才能调用云 API（cos:List*、cos:Get*、cos:Head*、cos:OptionsObject），对 1250000000 用户下的 dir1 目录下的文件进行读取操作。
ABAC 规定的四类属性分别是：</p>
<ul>
<li>用户属性：用户为 1250000000。</li>
<li>资源属性：dir1 目录下的文件。</li>
<li>操作属性：读取（cos:List*、cos:Get*、cos:Head*、cos:OptionsObject 都是读取 API）。</li>
<li>环境属性：10.217.182.3/24 或者 111.21.33.72/24 网段。</li>
</ul>
<h1 id="第二十讲-iam-apiserver设计">第二十讲 iam-apiserver设计</h1>
<p>iam-apiserver是一个web服务，对外提供RESTful API接口，
完成对用户、秘钥、策略三种资源的增删改查</p>
<h2 id="功能介绍">功能介绍</h2>
<h3 id="认证相关接口">认证相关接口</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>/login</td>
<td>用户登录</td>
</tr>
<tr>
<td>POST</td>
<td>/logout</td>
<td>用户登出</td>
</tr>
<tr>
<td>POST</td>
<td>/refresh</td>
<td>刷新Token</td>
</tr>
</tbody>
</table>
<h3 id="用户相关接口">用户相关接口</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>/v1/users</td>
<td>创建用户</td>
</tr>
<tr>
<td>DELETE</td>
<td>/v1/users</td>
<td>批量删除用户</td>
</tr>
<tr>
<td>DELETE</td>
<td>/v1/users/:name</td>
<td>删除用户</td>
</tr>
<tr>
<td>PUT</td>
<td>/v1/users/:name/change_password</td>
<td>修改用户密码</td>
</tr>
<tr>
<td>PUT</td>
<td>/v1/users/:name</td>
<td>修改用户属性</td>
</tr>
<tr>
<td>GET</td>
<td>/v1/users/:name</td>
<td>查询用户信息</td>
</tr>
<tr>
<td>GET</td>
<td>/v1/users</td>
<td>查询用户列表</td>
</tr>
</tbody>
</table>
<h3 id="秘钥相关接口">秘钥相关接口</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>/v1/secrets</td>
<td>创建秘钥</td>
</tr>
<tr>
<td>DELETE</td>
<td>/v1/secrets/:name</td>
<td>删除秘钥</td>
</tr>
<tr>
<td>PUT</td>
<td>/v1/secrets/:name</td>
<td>修改秘钥属性</td>
</tr>
<tr>
<td>GET</td>
<td>/v1/secrets/:name</td>
<td>查询秘钥信息</td>
</tr>
<tr>
<td>GET</td>
<td>/v1/secrets</td>
<td>查询秘钥列表</td>
</tr>
</tbody>
</table>
<h3 id="策略相关接口">策略相关接口</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>/v1/policies</td>
<td>创建授权策略</td>
</tr>
<tr>
<td>DELETE</td>
<td>/v1/policies</td>
<td>批量删除授权策略</td>
</tr>
<tr>
<td>DELETE</td>
<td>/v1/policies/:name</td>
<td>删除授权策略</td>
</tr>
<tr>
<td>PUT</td>
<td>/v1/policies/:name</td>
<td>修改授权策略属性</td>
</tr>
<tr>
<td>GET</td>
<td>/v1/policies/:name</td>
<td>查询授权策略信息</td>
</tr>
<tr>
<td>GET</td>
<td>/v1/policies</td>
<td>查询授权策略列表</td>
</tr>
</tbody>
</table>
<p>推荐使用<code>curl</code>测试， 测试样例集成到脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ <span class="nb">export</span> <span class="nv">IAM_APISERVER_HOST</span><span class="o">=</span>127.0.0.1 <span class="c1"># iam-apiserver部署服务器的IP地址</span>
$ <span class="nb">export</span> <span class="nv">IAM_APISERVER_INSECURE_BIND_PORT</span><span class="o">=</span><span class="m">8080</span> <span class="c1"># iam-apiserver HTTP服务的监听端口</span>
$ ./scripts/install/test.sh iam::test::apiserver
</code></pre></td></tr></table>
</div>
</div><h2 id="代码实现">代码实现</h2>
<h3 id="配置处理">配置处理</h3>
<p>配置分为三种</p>
<ul>
<li>Options配置：用来构建命令行配置（默认配置先被命令行覆盖，然后被命令行参数覆盖）</li>
<li>Configs应用配置：HTTP/GRPC的地址和端口、数据库配置等等，输入来自上一步</li>
<li>服务配置：服务启动的配置，输入来自上一步</li>
</ul>
<h3 id="启动流程">启动流程</h3>
<p><img src="/image/go_develop_in_action/28_1.webp" alt="apiserver-start-process"></p>
<ol>
<li>初始化Options</li>
<li>配置启动函数<code>run</code>: 封装启动逻辑，初始化日志包、Configs</li>
<li>根据Configs应用配置，创建复位启动配置，进而创建HTTP/GRPC服务实例</li>
<li>调用<code>Prerun</code>: 初始化路由、中间件、数据库</li>
<li>调用<code>Run</code>: 启动HTTP/GRPC服务</li>
</ol>
<h3 id="请求处理">请求处理</h3>
<p><img src="/image/go_develop_in_action/28_2.webp" alt="apiserver-restful-process"></p>
<h3 id="代码架构">代码架构</h3>
<p><img src="/image/go_develop_in_action/28_3.webp" alt="apiserver-project-structure"></p>
<p>代码架构分为4层： 模型层（Models）、控制层（Controller）、业务层（Service）、仓库层（Repository）</p>
<p>层与层之间有严格的导入关系，防止循环导入的问题，具体如下：</p>
<ul>
<li>模型层可以被仓库层、业务层和控制层导入</li>
<li>业务层可以导入仓库层的包</li>
<li>控制层可以业务层，特殊情况可以导入仓库层</li>
</ul>
<p>具体看一下每一层</p>
<ol>
<li>模型层（Models）
模型层，也称实体层（Entities），IAM项目将模型层单独放在了一个仓库，方便其他项目共用</li>
</ol>
<p>模型即可作为数据库模型，又可作为API接口的入参模型或出参模型，如果有差异可以新建模型来适配</p>
<ol start="2">
<li>
<p>仓库层（Repository）
仓库层用来和数据库进行CURD交互，并起到数据转换的作用</p>
</li>
<li>
<p>业务层（Service）</p>
</li>
</ol>
<p><img src="/image/go_develop_in_action/28_4.webp" alt="apiserver-service-level"></p>
<p>业务层主要完成业务逻辑处理</p>
<ol start="4">
<li>控制层（Controller）</li>
</ol>
<p><img src="/image/go_develop_in_action/28_5.webp" alt="apiserver-controller-level"></p>
<p>控制层接收HTTP请求，并进行参数解析、参数校验、逻辑分发处理、请求返回这些操作</p>
<p>控制层、业务层、仓库层之间是通过Interface通信</p>
<p>业务层和仓库层都使用的工厂方法设计模式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kd">type</span> <span class="nx">Service</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Users</span><span class="p">()</span> <span class="nx">UserSrv</span>
    <span class="nf">Secrets</span><span class="p">()</span> <span class="nx">SecretSrv</span>
    <span class="nf">Policies</span><span class="p">()</span> <span class="nx">PolicySrv</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">UserSrv</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">user</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">CreateOptions</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">user</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">UpdateOptions</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">username</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nf">DeleteCollection</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">usernames</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">username</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">UserList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nf">ListWithBadPerformance</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">UserList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nf">ChangePassword</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">user</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="第二十一讲-iam-apiserver核心功能实现">第二十一讲 iam-apiserver核心功能实现</h1>
<h2 id="应用框架相关">应用框架相关</h2>
<h3 id="优雅关停">优雅关停</h3>
<h4 id="方式1">方式1</h4>
<p>SetupSignalHandler</p>
<ul>
<li>通过onlyOneSignalHandler确保只被调用一次</li>
<li>第一次接受信号，优雅关停，第二次强制退出</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kd">var</span> <span class="nx">onlyOneSignalHandler</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>

<span class="kd">var</span> <span class="nx">shutdownHandler</span> <span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span>

<span class="kd">func</span> <span class="nf">SetupSignalHandler</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span> <span class="p">{</span>
    <span class="nb">close</span><span class="p">(</span><span class="nx">onlyOneSignalHandler</span><span class="p">)</span> <span class="c1">// panics when called twice
</span><span class="c1"></span>
    <span class="nx">shutdownHandler</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="nx">stop</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>

    <span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">shutdownHandler</span><span class="p">,</span> <span class="nx">shutdownSignals</span><span class="o">...</span><span class="p">)</span>

    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">&lt;-</span><span class="nx">shutdownHandler</span>
        <span class="nb">close</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span>
        <span class="o">&lt;-</span><span class="nx">shutdownHandler</span>
        <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">// second signal. Exit directly.
</span><span class="c1"></span>    <span class="p">}()</span>

    <span class="k">return</span> <span class="nx">stop</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">grpcAPIServer</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
<span class="nx">listen</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">address</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to listen: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
<span class="p">}</span>

<span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Start grpc server at %s&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">address</span><span class="p">)</span>

<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">listen</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to start grpc server: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
<span class="p">}</span>
<span class="p">}()</span>

<span class="o">&lt;-</span><span class="nx">stopCh</span>

<span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Grpc server on %s stopped&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">address</span><span class="p">)</span>
<span class="nx">s</span><span class="p">.</span><span class="nf">GracefulStop</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="方式2">方式2</h4>
<p>封装GracefulShutdown，
通过<code>ShutdownManager</code>监听指定信号
通过<code>ShutdownCallback</code>处理后续逻辑</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">GracefulShutdown</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">callbacks</span>    <span class="p">[]</span><span class="nx">ShutdownCallback</span>
	<span class="nx">managers</span>     <span class="p">[]</span><span class="nx">ShutdownManager</span>
	<span class="nx">errorHandler</span> <span class="nx">ErrorHandler</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">gs</span> <span class="o">*</span><span class="nx">GracefulShutdown</span><span class="p">)</span> <span class="nf">AddShutdownManager</span><span class="p">(</span><span class="nx">manager</span> <span class="nx">ShutdownManager</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">gs</span><span class="p">.</span><span class="nx">managers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gs</span><span class="p">.</span><span class="nx">managers</span><span class="p">,</span> <span class="nx">manager</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">gs</span> <span class="o">*</span><span class="nx">GracefulShutdown</span><span class="p">)</span> <span class="nf">AddShutdownCallback</span><span class="p">(</span><span class="nx">shutdownCallback</span> <span class="nx">ShutdownCallback</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">gs</span><span class="p">.</span><span class="nx">callbacks</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gs</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">,</span> <span class="nx">shutdownCallback</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="健康检查">健康检查</h3>
<p>server启动后会尝试ping <code>/healthz</code> 接口确保服务启动正常</p>
<h3 id="插件化加载中间件">插件化加载中间件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">GenericAPIServer</span><span class="p">)</span> <span class="nf">InstallMiddlewares</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// necessary middlewares
</span><span class="c1"></span>    <span class="nx">s</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">middleware</span><span class="p">.</span><span class="nf">RequestID</span><span class="p">())</span>
    <span class="nx">s</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">middleware</span><span class="p">.</span><span class="nf">Context</span><span class="p">())</span>

    <span class="c1">// install custom middlewares
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">middlewares</span> <span class="p">{</span>
        <span class="nx">mw</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">Middlewares</span><span class="p">[</span><span class="nx">m</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;can not find middleware: %s&#34;</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span>

            <span class="k">continue</span>
        <span class="p">}</span>

        <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;install middleware: %s&#34;</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span>
        <span class="nx">s</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">mw</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="编程规范相关">编程规范相关</h2>
<h3 id="api版本">API版本</h3>
<ul>
<li>API版本号放在URI中，如<code>/v1/secrets</code></li>
<li>API路径和控制层、业务层、模型层的代码想映射</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">internal/apiserver/controller/v1/secret/  <span class="c1"># 控制几层代码存放位置</span>
internal/apiserver/service/v1/secret.go <span class="c1"># 业务层代码存放位置</span>
github.com/marmotedu/api/apiserver/v1/secret.go <span class="c1"># 模型层代码存放位置</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>CRUD每个接口可以一个文件</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ ls internal/apiserver/controller/v1/secret/
create.go  delete_collection.go  delete.go  doc.go  get.go  list.go  secret.go  update.go
</code></pre></td></tr></table>
</div>
</div><h3 id="统一资源元数据">统一资源元数据</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ObjectMeta</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">ID</span> <span class="kt">uint64</span> <span class="s">`json:&#34;id,omitempty&#34; gorm:&#34;primary_key;AUTO_INCREMENT;column:id&#34;`</span>
  <span class="nx">InstanceID</span> <span class="kt">string</span> <span class="s">`json:&#34;instanceID,omitempty&#34; gorm:&#34;unique;column:instanceID;type:varchar(32);not null&#34;`</span>
  <span class="nx">Name</span> <span class="kt">string</span> <span class="s">`json:&#34;name,omitempty&#34; gorm:&#34;column:name;type:varchar(64);not null&#34; validate:&#34;name&#34;`</span>
  <span class="nx">Extend</span> <span class="nx">Extend</span> <span class="s">`json:&#34;extend,omitempty&#34; gorm:&#34;-&#34; validate:&#34;omitempty&#34;`</span>
  <span class="nx">ExtendShadow</span> <span class="kt">string</span> <span class="s">`json:&#34;-&#34; gorm:&#34;column:extendShadow&#34; validate:&#34;omitempty&#34;`</span>
  <span class="nx">CreatedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&#34;createdAt,omitempty&#34; gorm:&#34;column:createdAt&#34;`</span>
  <span class="nx">UpdatedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&#34;updatedAt,omitempty&#34; gorm:&#34;column:updatedAt&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Secret</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">// May add TypeMeta in the future.
</span><span class="c1"></span>  <span class="c1">// metav1.TypeMeta `json:&#34;,inline&#34;`
</span><span class="c1"></span>  
  <span class="c1">// Standard object&#39;s metadata.
</span><span class="c1"></span>  <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`       json:&#34;metadata,omitempty&#34;`</span>
  <span class="nx">Username</span>          <span class="kt">string</span> <span class="s">`json:&#34;username&#34;           gorm:&#34;column:username&#34;  validate:&#34;omitempty&#34;`</span>
  <span class="nx">SecretID</span>          <span class="kt">string</span> <span class="s">`json:&#34;secretID&#34;           gorm:&#34;column:secretID&#34;  validate:&#34;omitempty&#34;`</span>
  <span class="nx">SecretKey</span>         <span class="kt">string</span> <span class="s">`json:&#34;secretKey&#34;          gorm:&#34;column:secretKey&#34; validate:&#34;omitempty&#34;`</span>
  
  <span class="c1">// Required: true
</span><span class="c1"></span>  <span class="nx">Expires</span>     <span class="kt">int64</span>  <span class="s">`json:&#34;expires&#34;     gorm:&#34;column:expires&#34;     validate:&#34;omitempty&#34;`</span>
  <span class="nx">Description</span> <span class="kt">string</span> <span class="s">`json:&#34;description&#34; gorm:&#34;column:description&#34; validate:&#34;description&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>apiserver中所有的资源都是REST资源，具体分为两种属性</p>
<ul>
<li>公共属性</li>
<li>资源自由数据</li>
</ul>
<h4 id="公共属性介绍">公共属性介绍</h4>
<ol>
<li>ID</li>
</ol>
<p>映射为数据库的id字段，但业务层并没有用到</p>
<ol start="2">
<li>InstanceID</li>
</ol>
<p>资源的唯一标识，格式为<code>resource-random_str</code>,如<code>secrest-yj8m30</code></p>
<p>InstanceID通过gorm提供的HOOK自动更新</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Secret</span><span class="p">)</span> <span class="nf">AfterCreate</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">InstaceID</span> <span class="p">=</span> <span class="nx">iduti</span><span class="p">.</span><span class="nf">GetInstanceId</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="s">&#34;secret-&#34;</span><span class="p">)</span>
	
	<span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Save</span><span class="p">(</span><span class="nx">s</span><span class="p">).</span><span class="nx">Error</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>使用InstanceID的优点有：</p>
<ul>
<li>看标识名就知道什么类型的资源，方便 排障</li>
<li>长度可控，相比UUID占用空间小</li>
<li>相比ID字段隐私性强，不会暴露数据规模</li>
</ul>
<ol start="3">
<li>Extend 和 ExtendShadow
为了满足满足表格动态扩展字段但有不想在数据库中加字段的情况，我们
在业务逻辑中加Extend字段，序列化好以ExtendShadow存到数据库中</li>
</ol>
<p>Extend是 map[string]interface{} 类型
ExtendShadow 是 Mysql text 类型
两者之间通过gorm Hook自动序列化和反序列化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// BeforeCreate run before create database record.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Secret</span><span class="p">)</span> <span class="nf">BeforeCreate</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">ExtendShadow</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Extend</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>

	<span class="k">return</span>
<span class="p">}</span>

<span class="c1">// BeforeUpdate run before update database record.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Secret</span><span class="p">)</span> <span class="nf">BeforeUpdate</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">s</span><span class="p">.</span><span class="nx">ExtendShadow</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Extend</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>

<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// AfterFind run after find to unmarshal a extend shadown string into metav1.Extend struct.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Secret</span><span class="p">)</span> <span class="nf">AfterFind</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ExtendShadow</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">s</span><span class="p">.</span><span class="nx">Extend</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>CreateAt 和 UpdateAt</li>
</ol>
<p>gorm会自动处理这两个字段</p>
<h3 id="统一返回">统一返回</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">WriteResponse</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">data</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%#+v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="nx">coder</span> <span class="o">:=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">ParseCoder</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">coder</span><span class="p">.</span><span class="nf">HTTPStatus</span><span class="p">(),</span> <span class="nx">ErrResponse</span><span class="p">{</span>
            <span class="nx">Code</span><span class="p">:</span>      <span class="nx">coder</span><span class="p">.</span><span class="nf">Code</span><span class="p">(),</span>
            <span class="nx">Message</span><span class="p">:</span>   <span class="nx">coder</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span>
            <span class="nx">Reference</span><span class="p">:</span> <span class="nx">coder</span><span class="p">.</span><span class="nf">Reference</span><span class="p">(),</span>
        <span class="p">})</span>

        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="并发处理">并发处理</h3>
<p>查询列表接口时可能需要对于查出来的每一条记录做一些其他逻辑处理，需要并发处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">userService</span><span class="p">)</span> <span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">UserList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">users</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Users</span><span class="p">().</span><span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">L</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;list users from storage failed: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>

    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">WithCode</span><span class="p">(</span><span class="nx">code</span><span class="p">.</span><span class="nx">ErrDatabase</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
  <span class="p">}</span>

  <span class="nx">wg</span> <span class="o">:=</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">{}</span>
  <span class="nx">errChan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="nx">finished</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

  <span class="kd">var</span> <span class="nx">m</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span>

  <span class="c1">// Improve query efficiency in parallel
</span><span class="c1"></span>  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">user</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">users</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
    <span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">user</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>

            <span class="c1">// some cost time process
</span><span class="c1"></span>      <span class="nx">policies</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Policies</span><span class="p">().</span><span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{})</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">errChan</span> <span class="o">&lt;-</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">WithCode</span><span class="p">(</span><span class="nx">code</span><span class="p">.</span><span class="nx">ErrDatabase</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>

        <span class="k">return</span>
      <span class="p">}</span>

      <span class="nx">m</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">v1</span><span class="p">.</span><span class="nx">User</span><span class="p">{</span>
                <span class="o">...</span>
        <span class="nx">Phone</span><span class="p">:</span>       <span class="nx">user</span><span class="p">.</span><span class="nx">Phone</span><span class="p">,</span>
        <span class="nx">TotalPolicy</span><span class="p">:</span> <span class="nx">policies</span><span class="p">.</span><span class="nx">TotalCount</span><span class="p">,</span>
      <span class="p">})</span>
    <span class="p">}(</span><span class="nx">user</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
    <span class="nb">close</span><span class="p">(</span><span class="nx">finished</span><span class="p">)</span>
  <span class="p">}()</span>

  <span class="k">select</span> <span class="p">{</span>
  <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">finished</span><span class="p">:</span>
  <span class="k">case</span> <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">errChan</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="c1">// infos := make([]*v1.User, 0)
</span><span class="c1"></span>  <span class="nx">infos</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">users</span><span class="p">.</span><span class="nx">Items</span><span class="p">))</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">user</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">users</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
    <span class="nx">info</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
    <span class="nx">infos</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">infos</span><span class="p">,</span> <span class="nx">info</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">User</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="nx">log</span><span class="p">.</span><span class="nf">L</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;get %d users from backend storage.&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">infos</span><span class="p">))</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">v1</span><span class="p">.</span><span class="nx">UserList</span><span class="p">{</span><span class="nx">ListMeta</span><span class="p">:</span> <span class="nx">users</span><span class="p">.</span><span class="nx">ListMeta</span><span class="p">,</span> <span class="nx">Items</span><span class="p">:</span> <span class="nx">infos</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如上示例结合了 chan、sync.Map和WaitGroup</p>
<h2 id="其他-1">其他</h2>
<h3 id="插件化选择json库">插件化选择JSON库</h3>
<p>通过使用<code>+build</code>标签构建的时候自动使用对应的json库</p>
<h3 id="调用链实现">调用链实现</h3>
<p>Context中间件会设置好RequestID和Username信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Context</span><span class="p">()</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">KeyRequestID</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="nx">XRequestIDKey</span><span class="p">))</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">KeyUsername</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="nx">UsernameKey</span><span class="p">))</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>log.L(ctx context.Context)函数会打印调用链信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="mi">2021</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">19</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">33</span><span class="p">.</span><span class="mi">472</span><span class="w"> </span><span class="n">INFO</span><span class="w">    </span><span class="n">apiserver</span><span class="w">       </span><span class="n">apiserver</span><span class="o">/</span><span class="n">auth</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="mi">205</span><span class="w">   </span><span class="k">user</span><span class="w"> </span><span class="o">`</span><span class="n">admin</span><span class="o">`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">authenticated</span><span class="p">.</span><span class="w">  </span><span class="err">{</span><span class="s2">&#34;requestID&#34;</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;b6c56cd3-d095-4fd5-a928-291a2e33077f&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;username&#34;</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;admin&#34;</span><span class="err">}</span><span class="w">
</span><span class="w"></span><span class="mi">2021</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">19</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">33</span><span class="p">.</span><span class="mi">472</span><span class="w"> </span><span class="n">INFO</span><span class="w">    </span><span class="n">apiserver</span><span class="w">       </span><span class="n">policy</span><span class="o">/</span><span class="k">create</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="mi">22</span><span class="w">     </span><span class="k">create</span><span class="w"> </span><span class="n">policy</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">called</span><span class="p">.</span><span class="w">  </span><span class="err">{</span><span class="s2">&#34;requestID&#34;</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;b6c56cd3-d095-4fd5-a928-291a2e33077f&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;username&#34;</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;admin&#34;</span><span class="err">}</span><span class="w">
</span><span class="w"></span><span class="p">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="数据一致性">数据一致性</h3>
<p><img src="/image/go_develop_in_action/29_1.webp" alt="authz-server-data-sync"></p>
<ul>
<li>authz-server启动时会通过grpc接口调用api-server获取数据</li>
<li>当api-server数据更新时，发通过redis发信心给authz-server</li>
<li>authz-server订阅收到信息后会重新通过grpc接口加载全量数据</li>
</ul>
<h1 id="第二十二讲-gorm介绍">第二十二讲 GORM介绍</h1>
<h2 id="常用操作">常用操作</h2>
<h3 id="模型定义">模型定义</h3>
<p>通过<code>column</code>标签指定列名，通过给Model添加TableName方法指定表名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kd">type</span> <span class="nx">Animal</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">AnimalID</span> <span class="kt">int64</span>     <span class="s">`gorm:&#34;column:animalID;primarykey&#34;`</span> <span class="c1">// 将列名设为 `animalID`
</span><span class="c1"></span>    <span class="nx">Birthday</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`gorm:&#34;column:birthday&#34;`</span>            <span class="c1">// 将列名设为 `birthday`
</span><span class="c1"></span>    <span class="nx">Age</span>      <span class="kt">int64</span>     <span class="s">`gorm:&#34;column:age&#34;`</span>                 <span class="c1">// 将列名设为 `age`
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Animal</span><span class="p">)</span> <span class="nf">TableName</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&#34;animal&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="连接数据库">连接数据库</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;gorm.io/driver/mysql&#34;</span>
  <span class="s">&#34;gorm.io/gorm&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 参考 https://github.com/go-sql-driver/mysql#dsn-data-source-name 获取详情
</span><span class="c1"></span>  <span class="nx">dsn</span> <span class="o">:=</span> <span class="s">&#34;user:pass@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&#34;</span>
  <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">mysql</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">dsn</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">Config</span><span class="p">{})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="创建记录">创建记录</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">gorm</span><span class="p">.</span><span class="nx">Model</span>
  <span class="nx">Name</span>         <span class="kt">string</span>
  <span class="nx">Age</span>          <span class="kt">uint8</span>
  <span class="nx">Birthday</span>     <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
<span class="p">}</span>
<span class="nx">user</span> <span class="o">:=</span> <span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Jinzhu&#34;</span><span class="p">,</span> <span class="nx">Age</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="nx">Birthday</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()}</span>
<span class="nx">result</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span> <span class="c1">// 通过数据的指针来创建
</span></code></pre></td></tr></table>
</div>
</div><p>db.Create 函数会返回三个值</p>
<ul>
<li>user.ID: 主键，直接赋值给user变量</li>
<li>result.Error: error</li>
<li>result.RowsAffected: 插入记录的条数</li>
</ul>
<h3 id="删除记录">删除记录</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="c1">// DELETE from users where id = 10 AND name = &#34;jinzhu&#34;;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;name = ?&#34;</span><span class="p">,</span> <span class="s">&#34;jinzhu&#34;</span><span class="p">).</span><span class="nf">Delete</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">User</span><span class="p">{})</span>


<span class="c1">// DELETE FROM users WHERE id = 10;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">User</span><span class="p">{},</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>当模型中包含<code>DeletedAt</code>字段时，默认 执行 软删除</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="c1">// UPDATE users SET deleted_at=&#34;2013-10-29 10:23&#34; WHERE age = 20;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;age = ?&#34;</span><span class="p">,</span> <span class="mi">20</span><span class="p">).</span><span class="nf">Delete</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">User</span><span class="p">{})</span>

<span class="c1">// SELECT * FROM users WHERE age = 20 AND deleted_at IS NULL;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;age = 20&#34;</span><span class="p">).</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>永久删除可用 Unscoped</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// DELETE FROM orders WHERE id=10;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Unscoped</span><span class="p">().</span><span class="nf">Delete</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">order</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="更新记录">更新记录</h3>
<p>获取记录实例再更新</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">.</span><span class="nf">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>

<span class="nx">user</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="s">&#34;jinzhu 2&#34;</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">Age</span> <span class="p">=</span> <span class="mi">100</span>
<span class="c1">// UPDATE users SET name=&#39;jinzhu 2&#39;, age=100, birthday=&#39;2016-01-01&#39;, updated_at = &#39;2013-11-17 21:34:10&#39; WHERE id=111;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Save</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>指定列更新</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// UPDATE users SET age=200, updated_at=&#39;2013-11-17 21:34:10&#39; WHERE name=&#39;colin&#39;;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Model</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">User</span><span class="p">{}).</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;name = ?&#34;</span><span class="p">,</span> <span class="s">&#34;colin&#34;</span><span class="p">).</span><span class="nf">Update</span><span class="p">(</span><span class="s">&#34;age&#34;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

<span class="c1">// UPDATE users SET name=&#39;hello&#39;, age=18, updated_at = &#39;2013-11-17 21:34:10&#39; WHERE name = &#39;colin&#39;;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Model</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">).</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;colin&#34;</span><span class="p">).</span><span class="nf">Updates</span><span class="p">(</span><span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;hello&#34;</span><span class="p">,</span> <span class="nx">Age</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="nx">Active</span><span class="p">:</span> <span class="kc">false</span><span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="查询记录">查询记录</h3>
<p>简单查询</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 获取第一条记录（主键升序）
</span><span class="c1">// SELECT * FROM users ORDER BY id LIMIT 1;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>

<span class="c1">// 获取最后一条记录（主键降序）
</span><span class="c1">// SELECT * FROM users ORDER BY id DESC LIMIT 1;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Last</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>
<span class="nx">result</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>
<span class="nx">result</span><span class="p">.</span><span class="nx">RowsAffected</span> <span class="c1">// 返回找到的记录数
</span><span class="c1"></span><span class="nx">result</span><span class="p">.</span><span class="nx">Error</span>        <span class="c1">// returns error
</span><span class="c1"></span>
<span class="c1">// 检查 ErrRecordNotFound 错误
</span><span class="c1"></span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">Error</span><span class="p">,</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">ErrRecordNotFound</span><span class="p">)</span>


<span class="nx">users</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">User</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">// SELECT * FROM users WHERE name &lt;&gt; &#39;jinzhu&#39;;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;name &lt;&gt; ?&#34;</span><span class="p">,</span> <span class="s">&#34;jinzhu&#34;</span><span class="p">).</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">users</span><span class="p">)</span>


<span class="kd">type</span> <span class="nx">APIUser</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="nx">ID</span>   <span class="kt">uint</span>
<span class="nx">Name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// SELECT `id`, `name` FROM `users` LIMIT 10;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Model</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">User</span><span class="p">{}).</span><span class="nf">Limit</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">APIUser</span><span class="p">{})</span>
</code></pre></td></tr></table>
</div>
</div><p>高级查询</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// SELECT * FROM users ORDER BY age desc, name;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Order</span><span class="p">(</span><span class="s">&#34;age desc, name&#34;</span><span class="p">).</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">users</span><span class="p">)</span>

<span class="c1">// SELECT * FROM users OFFSET 5 LIMIT 10;
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Limit</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nf">Offset</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">users</span><span class="p">)</span>

<span class="c1">// Distinct
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Distinct</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">).</span><span class="nf">Order</span><span class="p">(</span><span class="s">&#34;name, age desc&#34;</span><span class="p">).</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">results</span><span class="p">)</span>


<span class="kd">var</span> <span class="nx">count</span> <span class="kt">int64</span>
<span class="c1">// SELECT count(1) FROM users WHERE name = &#39;jinzhu&#39;; (count)
</span><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nf">Model</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">User</span><span class="p">{}).</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;name = ?&#34;</span><span class="p">,</span> <span class="s">&#34;jinzhu&#34;</span><span class="p">).</span><span class="nf">Count</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">count</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>原生SQL</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kd">type</span> <span class="nx">Result</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">ID</span>   <span class="kt">int</span>
  <span class="nx">Name</span> <span class="kt">string</span>
  <span class="nx">Age</span>  <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">result</span> <span class="nx">Result</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">Raw</span><span class="p">(</span><span class="s">&#34;SELECT id, name, age FROM users WHERE name = ?&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">).</span><span class="nf">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span>


<span class="nx">db</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="s">&#34;DROP TABLE users&#34;</span><span class="p">)</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="s">&#34;UPDATE orders SET shipped_at=? WHERE id IN ?&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="钩子">钩子</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 插入记录前执行 BeforeCreate
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">User</span><span class="p">)</span> <span class="nf">BeforeCreate</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">u</span><span class="p">.</span><span class="nx">UUID</span> <span class="p">=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Name</span> <span class="o">==</span> <span class="s">&#34;admin&#34;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;invalid name&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="第二十三讲-数据流服务-authz-server-设计">第二十三讲 数据流服务 authz-server 设计</h1>
<h2 id="访问控制策略库-ladon">访问控制策略库 ladon</h2>
<p>策略样例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;One policy to rule them all.&#34;</span><span class="p">,</span>
  <span class="nt">&#34;subjects&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;users:&lt;peter|ken&gt;&#34;</span><span class="p">,</span> <span class="s2">&#34;users:maria&#34;</span><span class="p">,</span> <span class="s2">&#34;groups:admins&#34;</span><span class="p">],</span>
  <span class="nt">&#34;actions&#34;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&#34;delete&#34;</span><span class="p">,</span> <span class="s2">&#34;&lt;create|update&gt;&#34;</span><span class="p">],</span>
  <span class="nt">&#34;effect&#34;</span><span class="p">:</span> <span class="s2">&#34;allow&#34;</span><span class="p">,</span>
  <span class="nt">&#34;resources&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&#34;resources:articles:&lt;.*&gt;&#34;</span><span class="p">,</span>
    <span class="s2">&#34;resources:printer&#34;</span>
  <span class="p">],</span>
  <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;remoteIP&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;CIDRCondition&#34;</span><span class="p">,</span>
        <span class="nt">&#34;options&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;cidr&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.0.1/16&#34;</span>
        <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>一般策略包含6个元素</p>
<ul>
<li>主题 subject：授权主体，必须唯一</li>
<li>操作 action</li>
<li>效力 effect：表示结果是允许 allow 还是拒绝 deny</li>
<li>资源 resource：操作的对象</li>
<li>约束条件 condition：如IP、日期等</li>
<li>描述 description：策略说明</li>
</ul>
<p>假如有一个如下请求</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json">
<span class="p">{</span>
  <span class="nt">&#34;subject&#34;</span><span class="p">:</span> <span class="s2">&#34;users:peter&#34;</span><span class="p">,</span>
  <span class="nt">&#34;action&#34;</span> <span class="p">:</span> <span class="s2">&#34;delete&#34;</span><span class="p">,</span>
  <span class="nt">&#34;resource&#34;</span><span class="p">:</span> <span class="s2">&#34;resources:articles:ladon-introduction&#34;</span><span class="p">,</span>
  <span class="nt">&#34;context&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;remoteIP&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.0.5&#34;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>那么操作是允许的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;allowed&#34;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="authz-server-代码实现">authz-server 代码实现</h2>
<h3 id="启动流程-1">启动流程</h3>
<p><img src="/image/go_develop_in_action/31_1.webp" alt="authz-server-start"></p>
<h3 id="api请求处理流程">API请求处理流程</h3>
<p><img src="/image/go_develop_in_action/31_2.webp" alt="authz-server-request"></p>
<h3 id="代码架构-1">代码架构</h3>
<p><img src="/image/go_develop_in_action/31_3.webp" alt="authz-server-architecture"></p>
<h3 id="缓存更新">缓存更新</h3>
<p><img src="/image/go_develop_in_action/31_4.webp" alt="authz-server-cache"></p>
<h1 id="第二十四讲-数据采集">第二十四讲 数据采集</h1>
<p>通常一个大型应用为了后期排障和运营分析，会收集一些请求日志</p>
<h2 id="功能设计">功能设计</h2>
<p>数据采集系统通常分为两部分：数据上报、数据处理</p>
<p>为了提高异步数据上报的吞吐量，可以先将数据缓存在内存中，并使用多个worker去
消费内存中的数据</p>
<p><img src="/image/go_develop_in_action/32_1.webp" alt="data-collect"></p>
<h2 id="功能实现">功能实现</h2>
<p>iam中 authz-server实现了数据上报功能，pump服务实现数据采集功能</p>
<h3 id="数据上报">数据上报</h3>
<p>authz-sever实现要点</p>
<ul>
<li>上报功能开启、批量上报数量、时间间隔都可以配置</li>
<li>多个 worker共同消费一个chan 提高消费能力</li>
<li>优雅关停，确保停止时缓存的数据也会上报</li>
<li>使用msgpack序列化消息，msgpack比json更快更小</li>
</ul>
<h3 id="数据采集">数据采集</h3>
<p>pump服务消费Redis中的消费数据，然后保存在MongoDB中</p>
<p><img src="/image/go_develop_in_action/32_2.webp" alt="iam-pump-architecture"></p>
<h1 id="第二十五讲-公有云sdk设计">第二十五讲 公有云SDK设计</h1>
<h2 id="目录结构">目录结构</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">├── examples            # 示例代码存放目录
│   └── authz.go
├── README.md           # SDK使用文档
├── sdk                 # 公共包，封装了SDK配置、API请求、认证等代码
│   ├── client.go
│   ├── config.go
│   ├── credential.go
│   └── ...
└── services            # API封装
    ├── common
    │   └── model
    ├── iam             # iam服务的API接口
    │   ├── authz.go
    │   ├── client.go
    │   └── ...
    └── tms             # tms服务的API接口
</code></pre></td></tr></table>
</div>
</div><h2 id="设计方法">设计方法</h2>
<p><img src="/image/go_develop_in_action/31_1.webp" alt="sdk-architecture"></p>
<p>Client构造SDK客户端，请求Builder和Signer来构建请求参数，之后
请求Request模块发送请求</p>
<h1 id="第二十六讲-iam-sdk设计">第二十六讲 IAM SDK设计</h1>
<p>设计风格参考k8s的设计方式，大量使用interface特性，将接口定义和实现解耦；
多版本共存；接口调用曾经和资源层级相匹配</p>
<h2 id="设计思路">设计思路</h2>
<p>分层设计，有项目、应用和服务三个级别的接口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 项目级别的接口
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Interface</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Iam</span><span class="p">()</span> <span class="nx">iam</span><span class="p">.</span><span class="nx">IamInterface</span>
    <span class="nf">Tms</span><span class="p">()</span> <span class="nx">tms</span><span class="p">.</span><span class="nx">TmsInterface</span>
<span class="p">}</span>

<span class="c1">// 应用级别的接口
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">IamInterface</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">APIV1</span><span class="p">()</span> <span class="nx">apiv1</span><span class="p">.</span><span class="nx">APIV1Interface</span>
    <span class="nf">AuthzV1</span><span class="p">()</span> <span class="nx">authzv1</span><span class="p">.</span><span class="nx">AuthzV1Interface</span>
<span class="p">}</span>

<span class="c1">// 服务级别的接口
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">APIV1Interface</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">RESTClient</span><span class="p">()</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">Interface</span>
    <span class="nx">SecretsGetter</span>
    <span class="nx">UsersGetter</span>
    <span class="nx">PoliciesGetter</span>
<span class="p">}</span>

<span class="c1">// 资源级别的客户端
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">SecretsGetter</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Secrets</span><span class="p">()</span> <span class="nx">SecretInterface</span>
<span class="p">}</span>

<span class="c1">// 资源的接口定义
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">SecretInterface</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">secret</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">CreateOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">secret</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">UpdateOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nf">DeleteCollection</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">,</span> <span class="nx">listOpts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">SecretList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nx">SecretExpansion</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="使用实例">使用实例</h2>
<p>可以根据需求创建不同级别的客户端</p>
<h3 id="项目级客户端">项目级客户端</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;/root/.iam/config&#34;</span><span class="p">)</span>
<span class="nx">clientset</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">marmotedu</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="nx">rsp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientset</span><span class="p">.</span><span class="nf">Iam</span><span class="p">().</span><span class="nf">AuthzV1</span><span class="p">().</span><span class="nf">Authz</span><span class="p">().</span><span class="nf">Authorize</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="应用级客户端">应用级客户端</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;/root/.iam/config&#34;</span><span class="p">)</span>
<span class="nx">iamclient</span><span class="p">,,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">iam</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="nx">rsp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">iamclient</span><span class="p">.</span><span class="nf">AuthzV1</span><span class="p">().</span><span class="nf">Authz</span><span class="p">().</span><span class="nf">Authorize</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="服务级客户端">服务级客户端</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;/root/.iam/config&#34;</span><span class="p">)</span>
<span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">v1</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="nx">rsp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Authz</span><span class="p">().</span><span class="nf">Authorize</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="第二十七讲-iam-命令行工具设计">第二十七讲 IAM 命令行工具设计</h1>
<p><img src="/image/go_develop_in_action/35_1.webp" alt="cli-call"></p>
<h2 id="大型系统客户端的特点">大型系统客户端的特点</h2>
<ul>
<li>支持命令和子命令</li>
<li>支持特殊命令如version、completion（bash补全）</li>
<li>支持全局选项</li>
<li>支持<code>-h/--help</code>(帮助信息)</li>
</ul>
<h2 id="iamctl核心实现">iamctl核心实现</h2>
<p><img src="/image/go_develop_in_action/35_2.webp" alt="cli-functions"></p>
<h1 id="第二十八讲-如何编写单元测试和性能测试用例">第二十八讲 如何编写单元测试和性能测试用例</h1>
<h2 id="单元测试">单元测试</h2>
<p>示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">TestAbs</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tests</span> <span class="o">:=</span> <span class="p">[]</span><span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">x</span>    <span class="kt">float64</span>
        <span class="nx">want</span> <span class="kt">float64</span>
    <span class="p">}{</span>
        <span class="p">{</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">},</span>
        <span class="p">{</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
        <span class="p">{</span><span class="o">-</span><span class="mf">3.1</span><span class="p">,</span> <span class="mf">3.1</span><span class="p">},</span>
        <span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">tt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tests</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">got</span> <span class="o">:=</span> <span class="nf">Abs</span><span class="p">(</span><span class="nx">tt</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span> <span class="nx">got</span> <span class="o">!=</span> <span class="nx">tt</span><span class="p">.</span><span class="nx">want</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Abs() = %f, want %v&#34;</span><span class="p">,</span> <span class="nx">got</span><span class="p">,</span> <span class="nx">tt</span><span class="p">.</span><span class="nx">want</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以使用 <a href="github.com/stretchr/testify/assert">assert</a>库封装好的Equal、Less等 判断函数
可以使用 <a href="https://github.com/cweill/gotests">gotests</a>自动生成测试代码，这样只用填写测试参数就可以了</p>
<h2 id="性能测试">性能测试</h2>
<p>性能测试函数以<code>Benchmark</code>开头，参数类型为<code>*testing.B</code>，其中循环次数<code>N</code>会在运行时动态 吊装，以便可靠的计时</p>
<p><code>go test</code>需要添加 <code>-bench &lt;pattern&gt;</code>参数才会执行性能测试</p>
<h1 id="第二十九讲-iam测试介绍">第二十九讲 IAM测试介绍</h1>
<h2 id="示例测试">示例测试</h2>
<p>示例测试以<code>Example</code>开头， 执行<code>go test</code>命令时，会比较标出输出和注释的内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">ExmapleMax</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">Max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
	<span class="c1">// Output:
</span><span class="c1"></span>	<span class="c1">// 2
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="testmain-函数">TestMain 函数</h2>
<p>TestMain是一个特使的函数，可以在测试前后做相应的准备和清理工作，中间调用<code>m.Run()</code>函数才会执行普通的 测试函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span>  <span class="nf">TestMain</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;do some setup&#34;</span><span class="p">)</span>
	<span class="nx">m</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;do some setdown&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="mock测试">Mock测试</h2>
<p>使用<code>mockgen</code>生成Mock代码</p>
<p>参数说明
<img src="/image/go_develop_in_action/37_1.webp" alt="mockgen"></p>
<h3 id="生成方式">生成方式</h3>
<ol>
<li>源码模式</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ mockgen -destination spider/mock/mock_spider.go -package spider -source spider/spider.go
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>反射模式</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ mockgen -destination spider/mock/mock_spider.go -package spider github.com/marmotedu/gopractise-demo/gomock/spider Spider<span class="sb">```</span>
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>注释
在文件代码中添加注释</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//go:generate mockgen -destination mock_spider.go -package spider github.com/cz-it/blog/blog/Go/testing/gomock/example/spider Spider 
</span></code></pre></td></tr></table>
</div>
</div><p>然后执行以下面了就可自动生成Mock代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ go generate ./...
</code></pre></td></tr></table>
</div>
</div><h3 id="编写测试用例">编写测试用例</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 1. 创建Mock控制器
</span><span class="c1"></span><span class="nx">ctrl</span> <span class="o">:=</span> <span class="nx">gomock</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span>

<span class="c1">// 2. 创建Mock对象
</span><span class="c1"></span><span class="nx">mockSpider</span> <span class="o">:=</span> <span class="nx">spider</span><span class="p">.</span><span class="nf">NewMockSpider</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>
<span class="nx">want</span> <span class="o">:=</span> <span class="s">&#34;1.2.1&#34;</span>

<span class="c1">// 3. 指定方法的入参和返回值
</span><span class="c1"></span><span class="nx">mockSpider</span><span class="p">.</span><span class="nf">EXPECT</span><span class="p">().</span><span class="nf">GetBody</span><span class="p">().</span><span class="nf">Return</span><span class="p">(</span><span class="nx">want</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>参数匹配</p>
<ul>
<li>gomock.Any()，可以用来表示任意的入参。</li>
<li>gomock.Eq(value)，用来表示与 value 等价的值。</li>
<li>gomock.Not(value)，用来表示非 value 以外的值。</li>
<li>gomock.Nil()，用来表示 None 值</li>
</ul>
<p>Call对象约束</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Call</span><span class="p">)</span> <span class="nf">After</span><span class="p">(</span><span class="nx">preReq</span> <span class="o">*</span><span class="nx">Call</span><span class="p">)</span> <span class="o">*</span><span class="nx">Call</span> <span class="c1">// After声明调用在preReq完成后执行
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Call</span><span class="p">)</span> <span class="nf">AnyTimes</span><span class="p">()</span> <span class="o">*</span><span class="nx">Call</span> <span class="c1">// 允许调用次数为 0 次或更多次
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Call</span><span class="p">)</span> <span class="nf">Do</span><span class="p">(</span><span class="nx">f</span> <span class="kd">interface</span><span class="p">{})</span> <span class="o">*</span><span class="nx">Call</span> <span class="c1">// 声明在匹配时要运行的操作
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Call</span><span class="p">)</span> <span class="nf">MaxTimes</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">Call</span> <span class="c1">// 设置最大的调用次数为 n 次
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Call</span><span class="p">)</span> <span class="nf">MinTimes</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">Call</span> <span class="c1">// 设置最小的调用次数为 n 次
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Call</span><span class="p">)</span> <span class="nf">Return</span><span class="p">(</span><span class="nx">rets</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="o">*</span><span class="nx">Call</span> <span class="c1">//  // 声明模拟函数调用返回的值
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Call</span><span class="p">)</span> <span class="nf">SetArg</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">value</span> <span class="kd">interface</span><span class="p">{})</span> <span class="o">*</span><span class="nx">Call</span> <span class="c1">// 声明使用指针设置第 n 个参数的值
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Call</span><span class="p">)</span> <span class="nf">Times</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">Call</span> <span class="c1">// 设置调用次数为 n 次
</span></code></pre></td></tr></table>
</div>
</div><h2 id="fake测试">Fake测试</h2>
<p>对比比较复杂的接口，可以实现一个假的实例</p>
<h2 id="何时编写和执行单元测试">何时编写和执行单元测试</h2>
<p>推荐边写代码边写测试</p>
<h2 id="测试覆盖率">测试覆盖率</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">// 会生成一个converrate.out的文件
$ go <span class="nb">test</span> -coverprofile<span class="o">=</span>coverage.out


// 分析文件
$ go tool cover -func<span class="o">=</span>coverage.out


// 转成html文件
$ go tool cover -html<span class="o">=</span>coverage.out -o coverage.html

</code></pre></td></tr></table>
</div>
</div><h2 id="iam如何运行测试">IAM如何运行测试</h2>
<ol>
<li>make test</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">go</span>.<span class="n">test</span>
<span class="nf">go.test</span><span class="o">:</span> <span class="n">tools</span>.<span class="n">verify</span>.<span class="n">go</span>-<span class="n">junit</span>-<span class="n">report</span>
  @echo <span class="s2">&#34;===========&gt; Run unit test&#34;</span>
  @set -o pipefail<span class="p">;</span><span class="k">$(</span>GO<span class="k">)</span> <span class="nb">test</span> -race -cover -coverprofile<span class="o">=</span><span class="k">$(</span>OUTPUT_DIR<span class="k">)</span>/coverage.out <span class="se">\\</span>
    -timeout<span class="o">=</span>10m -short -v <span class="sb">`</span>go list ./...<span class="p">|</span><span class="se">\
</span><span class="se"></span>    egrep -v <span class="k">$(</span>subst <span class="k">$(</span>SPACE<span class="k">)</span>,<span class="s1">&#39;|&#39;</span>,<span class="k">$(</span>sort <span class="k">$(</span>EXCLUDE_TESTS<span class="k">)))</span><span class="sb">`</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> <span class="se">\\</span>
    tee &gt;<span class="o">(</span>go-junit-report --set-exit-code &gt;<span class="k">$(</span>OUTPUT_DIR<span class="k">)</span>/report.xml<span class="o">)</span>
  @sed -i <span class="s1">&#39;/mock_.*.go/d&#39;</span> <span class="k">$(</span>OUTPUT_DIR<span class="k">)</span>/coverage.out <span class="c1"># remove mock_.*.go files from test coverage</span>
  @<span class="k">$(</span>GO<span class="k">)</span> tool cover -html<span class="o">=</span><span class="k">$(</span>OUTPUT_DIR<span class="k">)</span>/coverage.out -o <span class="k">$(</span>OUTPUT_DIR<span class="k">)</span>/coverage.html
</code></pre></td></tr></table>
</div>
</div><p>测试中设置了超时时间、竞态检查、代码覆盖率检查、过滤Mock等不需要写测试的目录</p>
<ol start="2">
<li>make cover</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">go</span>.<span class="n">test</span>.<span class="n">cover</span>
<span class="nf">go.test.cover</span><span class="o">:</span> <span class="n">go</span>.<span class="n">test</span>
  @<span class="k">$(</span>GO<span class="k">)</span> tool cover -func<span class="o">=</span><span class="k">$(</span>OUTPUT_DIR<span class="k">)</span>/coverage.out <span class="p">|</span> <span class="se">\\</span>
    awk -v <span class="nv">target</span><span class="o">=</span><span class="k">$(</span>COVERAGE<span class="k">)</span> -f <span class="k">$(</span>ROOT_DIR<span class="k">)</span>/scripts/coverage.awk
</code></pre></td></tr></table>
</div>
</div><h1 id="第三十讲-如何分析go语言代码性能">第三十讲 如何分析Go语言代码性能</h1>
<h2 id="生成性能数据文件">生成性能数据文件</h2>
<h3 id="命令行生成">命令行生成</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">go <span class="nb">test</span> -bench<span class="o">=</span><span class="s2">&#34;.*&#34;</span> -cpuprofile cpu.profile  -memprofile mem.profile
</code></pre></td></tr></table>
</div>
</div><h3 id="代码生成">代码生成</h3>
<p>用代码来生成性能数据文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;os&#34;</span>
  <span class="s">&#34;runtime/pprof&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">cpuOut</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s">&#34;cpu.out&#34;</span><span class="p">)</span>
  <span class="k">defer</span> <span class="nx">cpuOut</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
  <span class="nx">pprof</span><span class="p">.</span><span class="nf">StartCPUProfile</span><span class="p">(</span><span class="nx">cpuOut</span><span class="p">)</span>
  <span class="k">defer</span> <span class="nx">pprof</span><span class="p">.</span><span class="nf">StopCPUProfile</span><span class="p">()</span>

  <span class="nx">memOut</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s">&#34;mem.out&#34;</span><span class="p">)</span>
  <span class="k">defer</span> <span class="nx">memOut</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
  <span class="k">defer</span> <span class="nx">pprof</span><span class="p">.</span><span class="nf">WriteHeapProfile</span><span class="p">(</span><span class="nx">memOut</span><span class="p">)</span>

  <span class="nf">Sum</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Sum</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="nethttppprof包生成">net/http/pprof包生成</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Register</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Engine</span><span class="p">,</span> <span class="nx">prefixOptions</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">prefix</span> <span class="o">:=</span> <span class="nf">getPrefix</span><span class="p">(</span><span class="nx">prefixOptions</span><span class="o">...</span><span class="p">)</span>

    <span class="nx">prefixRouter</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Group</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">...</span>
        <span class="nx">prefixRouter</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/profile&#34;</span><span class="p">,</span> <span class="nf">pprofHandler</span><span class="p">(</span><span class="nx">pprof</span><span class="p">.</span><span class="nx">Profile</span><span class="p">))</span>
        <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">pprofHandler</span><span class="p">(</span><span class="nx">h</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
    <span class="nx">handler</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>
    <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">handler</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以通过web访问对应页面查看
也可以将对应数据生成数据文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">curl http://127.0.0.1:8080/debug/pprof/heap -o mem.profile
</code></pre></td></tr></table>
</div>
</div><h2 id="性能分析">性能分析</h2>
<p><img src="/image/go_develop_in_action/38_1.webp" alt="prof_analyze"></p>
<h3 id="cpu性能分析">CPU性能分析</h3>
<ol>
<li>分析采样图</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">go tool pprof -svg cpu.profile &gt; cpu.svg <span class="c1"># svg 格式</span>
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>分析火焰图</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">go tool pprof -http<span class="o">=</span><span class="s2">&#34;0.0.0.0:8081&#34;</span> v1.test cpu.profile
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>交互模式查看详细数据</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">go tool  pprof v1.test cpu.profile
</code></pre></td></tr></table>
</div>
</div><p>常用交互命令有三个：top、list、peek</p>
<p><img src="/image/go_develop_in_action/38_2.webp" alt="pprof_interaction"></p>
<h3 id="内存性能分析">内存性能分析</h3>
<p>内存分析方式和CPU类似</p>
<h1 id="第三十一讲-apiserver性能测试和调优">第三十一讲 APIServer性能测试和调优</h1>
<h2 id="api性能测试指标">API性能测试指标</h2>
<p>衡量API性能的指标有三个：</p>
<ul>
<li>并发数（Concurrent）：同时请求同一个API的用户个数</li>
<li>请求响应时间（TTLB Time to last byte）：从客户端发起请求到收到服务端响应</li>
<li>每秒查询数（QPS）：QPS = 并发数 / 平均请求响应时间</li>
</ul>
<p>但测试一个接口时 QPS = TPS，测N个接口则 QPS = N * TPS</p>
<h2 id="api性能测试方法">API性能测试方法</h2>
<p>这里采用 <a href="https://github.com/wg/wrk">wrk</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">wrk -t144 -c30000 -d30s -T30s --latency http://localhost:8080/healthz
</code></pre></td></tr></table>
</div>
</div><p>集成脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">scripts/wrktest.sh http://10.0.4.57:8080/healthz
</code></pre></td></tr></table>
</div>
</div><p>结果
<img src="/image/go_develop_in_action/38_3.webp" alt="wrk_plot"></p>
<p>和net/http服务对比</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># start test server</span>
<span class="c1">#  go run tools/httptest/main.go</span>

<span class="c1"># client test</span>
scripts/wrktest.sh -n http http://10.0.4.57:6667/healthz


<span class="c1"># diff</span>
scripts/wrktest.sh diff _output/wrk/apiserver.dat _output/wrk/http.dat
</code></pre></td></tr></table>
</div>
</div><p>对比结果
<img src="/image/go_develop_in_action/38_4.webp" alt="wrk_diff"></p>
<h2 id="api接口性能标准参考">API接口性能标准参考</h2>
<p><img src="/image/go_develop_in_action/38_5.webp" alt="prof_standard"></p>
<h2 id="性能测试注意事项">性能测试注意事项</h2>
<h3 id="web框架性能">Web框架性能</h3>
<p>对Web框架测试选用的接口要足够简单</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">s</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/healthz&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">core</span><span class="p">.</span><span class="nf">WriteResponse</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;status&#34;</span><span class="p">:</span> <span class="s">&#34;ok&#34;</span><span class="p">})</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="api框架性能">API框架性能</h3>
<p>针对写接口，可借助单元测试来测试性能</p>
<p>对于读接口使用wrk这类压力测试工具来测试，通常读接口更可能遇到性能问题</p>
<h3 id="测试环境">测试环境</h3>
<p>有单独的环境，保证每次都在同一个测试环境测试</p>
<h1 id="参考">参考</h1>
<ul>
<li><a href="https://time.geekbang.org/column/intro/418">课程资源-Go 语言项目开发实战</a></li>
<li><a href="https://www.techgrow.cn/posts/5bd5a253.html">gcc升级</a></li>
<li><a href="https://github.com/protocolbuffers/protobuf/blob/master/docs/implementing_proto3_presence.md">proto3支持optional</a></li>
<li><a href="https://seisman.github.io/how-to-write-makefile">跟我一起写Makefile</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2015/02/make.html">Make命令教程</a></li>
<li><a href="https://unix.stackexchange.com/questions/272965/pushd-popd-vs-cd-cd-in-bash-and-zsh">pushd vs cd</a></li>
<li><a href="https://blog.51cto.com/liuzhengwei521/2120535">CSR证书生成</a></li>
<li><a href="https://segmentfault.com/a/1190000010540911">Oauth授权码模式</a></li>
<li><a href="https://gorm.io/docs/conventions.html#Timestamp-Tracking">gorm自动更新时间字段</a></li>
</ul>

    </div>

    
    


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://ppd0705.github.io/tags/golang/">Golang</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/getting_started_with_pencil_sketch/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">[笔记]零基础素描入门</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/learning_vue/">
            <span class="next-text nav-default">[笔记]VueJS学习</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "ppd0705/ppd0705.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="ppd0705@icloud.com" rel="me noopener" class="iconfont"
      title="email"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/ppd0705" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://github.com/ppd0705" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/ppd0705/" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>


<a href="https://ppd0705.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2019 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        PPD
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
